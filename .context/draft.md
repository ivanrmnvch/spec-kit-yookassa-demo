# –ß–µ—Ä–Ω–æ–≤–∏–∫ –ø—Ä–æ–µ–∫—Ç–∞: Backend-—Å–µ—Ä–≤–∏—Å –¥–ª—è –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –Æ–ö–∞—Å—Å—É

## üìã 1. –ê–ù–ê–õ–ò–ó –¢–†–ï–ë–û–í–ê–ù–ò–ô –¢–ó

### –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞
–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å Node.js backend-—Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ–ø–ª–∞—Ç—ã SaaS-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ –Æ–ö–∞—Å—Å—É.

### –ö–ª—é—á–µ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏–∑ –¢–ó
- ‚úÖ –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ë–î
- ‚úÖ –ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ Node.js
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API –º–µ—Ç–æ–¥—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- ‚úÖ –ó–∞—â–∏—Ç–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î
- ‚ö†Ô∏è **–í–∞–∂–Ω–æ**: –í—ã—è–≤–∏—Ç—å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
- üì¶ –†–µ–∑—É–ª—å—Ç–∞—Ç: –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –∏—Å—Ö–æ–¥–Ω—ã–º –∫–æ–¥–æ–º

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è
- **Backend only** (–±–µ–∑ frontend)
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π, –Ω–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**
- **–§–æ–∫—É—Å –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–ø–ª–∞—Ç—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—à–∏–±–æ–∫**
- **–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π –∏ –ø—Ä–æ–±–ª–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏**

---

## üé® 2. –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ö–ê–ß–ï–°–¢–í–£ –ò –ü–û–î–•–û–î–£

### 2.1. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∫–∞—á–µ—Å—Ç–≤–∞

#### üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- **README.md**: –ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
  - –û–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
  - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É (—Å ngrok)
  - –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
  - –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤
- **ARCHITECTURE_DECISIONS.md**: –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–µ—à–µ–Ω–∏–π
  - –ü–æ—á–µ–º—É –≤—ã–±—Ä–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å—Ç–µ–∫
  - –ü–æ–¥—Ö–æ–¥ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
  - –†–µ—à–µ–Ω–∏—è –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
  - –°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- **Swagger/OpenAPI**: –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API
  - –û–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö endpoints
  - –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤
  - –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

#### üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: Pino
  - **–í—ã–±–æ—Ä Pino** –≤–º–µ—Å—Ç–æ Winston –∏–∑-–∑–∞:
    - ‚ö° –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –≤—ã—à–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–≤ 5-10 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ Winston)
    - ü™∂ –ú–µ–Ω—å—à–∏–π overhead –∏ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
    - üîß –ù–∞—Ç–∏–≤–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    - üì¶ –ú–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä –±–∞–Ω–¥–ª–∞
  - JSON —Ñ–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤
  - –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Ä–æ–≤–Ω—è–º (debug, info, warn, error)
- **–ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:**
  - ‚úÖ –í—Å–µ –∏—Å—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –Æ–ö–∞—Å—Å–µ (request/response)
  - ‚úÖ –í—Å–µ –≤—Ö–æ–¥—è—â–∏–µ webhook –∑–∞–ø—Ä–æ—Å—ã (–ø–æ–ª–Ω–æ–µ —Ç–µ–ª–æ)
  - ‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π
  - ‚úÖ –í—Å–µ –æ—à–∏–±–∫–∏ —Å stack trace
  - ‚úÖ –ë–∏–∑–Ω–µ—Å-—Å–æ–±—ã—Ç–∏—è (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –æ—Ç–º–µ–Ω–∞)
- **Correlation ID**: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞ –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ –≤—Å—é —Å–∏—Å—Ç–µ–º—É
  - **–ß—Ç–æ —ç—Ç–æ:** "–¢—Ä–µ–∫–∏–Ω–≥-–Ω–æ–º–µ—Ä" –¥–ª—è HTTP-–∑–∞–ø—Ä–æ—Å–∞, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
  - **–ó–∞—á–µ–º:** –°–≤—è–∑–∞—Ç—å –≤–æ–µ–¥–∏–Ω–æ –≤—Å—é —Ü–µ–ø–æ—á–∫—É —Å–æ–±—ã—Ç–∏–π (API request ‚Üí –ë–î ‚Üí –Æ–ö–∞—Å—Å–∞ ‚Üí webhook)
  - **–ö–∞–∫:** –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –≤—Ö–æ–¥—è—â–µ–º –∑–∞–ø—Ä–æ—Å–µ, –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤–æ –≤—Å–µ –ª–æ–≥–∏ –∏ –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã
  - **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ü–æ–∏—Å–∫ –≤ –ª–æ–≥–∞—Ö –ø–æ `correlationId` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–∏
  - **–ù–µ –ø—É—Ç–∞—Ç—å —Å Payment ID:** Correlation ID ‚â† Payment ID (–æ–¥–∏–Ω –¥–ª—è —Ü–µ–ø–æ—á–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤, –¥—Ä—É–≥–æ–π –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–∏)
  
  ```javascript
  // –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞ —Å correlation ID
  {
    "correlationId": "req-abc-123",  // –û–¥–∏–Ω ID –¥–ª—è –≤—Å–µ–π —Ü–µ–ø–æ—á–∫–∏
    "timestamp": "2024-01-20T10:00:00Z",
    "level": "info",
    "message": "Payment created",
    "context": {
      "paymentId": "uuid",           // ID –ø–ª–∞—Ç–µ–∂–∞ –≤ –Ω–∞—à–µ–π –ë–î
      "yookassaPaymentId": "22e12...", // ID –ø–ª–∞—Ç–µ–∂–∞ –≤ –Æ–ö–∞—Å—Å–µ
      "userId": "uuid",
      "amount": 100.00
    }
  }
  ```
  
  ```typescript
  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
  // Middleware: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç correlation ID –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
  req.correlationId = req.headers['x-correlation-id'] || `req-${uuid()}`;
  
  // –í–æ –≤—Å–µ—Ö –ª–æ–≥–∞—Ö —É–∫–∞–∑—ã–≤–∞–µ–º correlation ID
  logger.child({ correlationId: req.correlationId }).info('Payment created');
  
  // –ü–µ—Ä–µ–¥–∞—ë–º –≤ –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã
  await yookassaService.createPayment(data, req.correlationId);
  ```

#### üéØ –ö–æ–¥-—Å—Ç–∞–π–ª –∏ —Ç–∏–ø–∏–∑–∞—Ü–∏—è
- **ESLint**: –°—Ç—Ä–æ–≥–∏–µ –ø—Ä–∞–≤–∏–ª–∞, –±–µ–∑ warnings
- **Prettier**: –ê–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- **TypeScript strict mode**: –í—Å–µ —Ñ–ª–∞–≥–∏ –≤–∫–ª—é—á–µ–Ω—ã
  ```json
  {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true
  }
  ```
- **Type safety**: 100% –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–∏–ø–∞–º–∏
  - –¢–∏–ø—ã –¥–ª—è –≤—Å–µ—Ö DTO
  - –¢–∏–ø—ã –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –Æ–ö–∞—Å—Å—ã
  - –ù–∏–∫–∞–∫–∏—Ö `any` —Ç–∏–ø–æ–≤

#### üê≥ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- **Docker Compose**: –ü–æ–ª–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π
  - PostgreSQL (–æ—Å–Ω–æ–≤–Ω–∞—è –ë–î)
  - Redis (–¥–ª—è rate limiting + idempotency keys)
  - Application container
- **–ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î**: 
  - –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã
  - Rollback —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
  - Seeds –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç–æ–ª—å–∫–æ Users, –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ API)
- **Environment validation**: 
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö required –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  - Fail-fast –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
  ```typescript
  // –ü—Ä–∏–º–µ—Ä –≤–∞–ª–∏–¥–∞—Ü–∏–∏
  const envSchema = z.object({
    DATABASE_URL: z.string().url(),
    YOOKASSA_SHOP_ID: z.string(),
    YOOKASSA_SECRET_KEY: z.string(),
    PORT: z.number().default(3000)
  });
  ```

#### üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**: Zod —Å—Ö–µ–º—ã –¥–ª—è –≤—Å–µ—Ö endpoints
  - **–í—ã–±–æ—Ä Zod** –≤–º–µ—Å—Ç–æ Joi –∏–∑-–∑–∞:
    - üéØ –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å TypeScript: —Ç–∏–ø—ã –≤—ã–≤–æ–¥—è—Ç—Å—è –∏–∑ —Å—Ö–µ–º (`z.infer<typeof Schema>`)
    - ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ 30-40% –≤—ã—à–µ, bundle –≤ 10 —Ä–∞–∑ –ª–µ–≥—á–µ (~4.5KB vs ~38KB gzipped)
    - üîß Zero duplication: –æ–¥–Ω–∞ —Å—Ö–µ–º–∞ = –≤–∞–ª–∏–¥–∞—Ü–∏—è + —Ç–∏–ø—ã (DRY principle)
    - üöÄ –õ—É—á—à–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —Å—Ç–µ–∫–æ–º (Express.js, Prisma, tRPC)
  - **–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
  ```typescript
  // –°—Ö–µ–º–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (—Ñ–æ—Ä–º–∞—Ç amount —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç API –Æ–ö–∞—Å—Å—ã)
  const AmountSchema = z.object({
    value: z.string().regex(/^\d+\.\d{2}$/),  // "100.00"
    currency: z.enum(['RUB']),
  });

  const CreatePaymentSchema = z.object({
    userId: z.string().uuid(),
    amount: AmountSchema,  // –û–±—ä–µ–∫—Ç { value, currency } —Å–æ–≥–ª–∞—Å–Ω–æ API –Æ–ö–∞—Å—Å—ã
    description: z.string().max(128).optional(),
    returnUrl: z.string().url(),
    metadata: z.object({
      userId: z.string().uuid(), // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –∏–∑ webhook
    }).catchall(z.string()).optional(),
  });
  
  // TypeScript —Ç–∏–ø –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–≤–æ–¥–∏—Ç—Å—è!
  type CreatePaymentDto = z.infer<typeof CreatePaymentSchema>;
  
  // Middleware –¥–ª—è Express.js
  const validated = CreatePaymentSchema.safeParse(req.body);
  if (!validated.success) {
    return res.status(400).json({ errors: validated.error.issues });
  }
  ```
- **Webhook verification**: 
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ IP –∞–¥—Ä–µ—Å–æ–≤ –Æ–ö–∞—Å—Å—ã
  - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ GET –∑–∞–ø—Ä–æ—Å
- **Graceful shutdown**: –ë–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ SIGTERM/SIGINT (Docker/K8s –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ)
  - –ó–∞–∫—Ä—ã—Ç–∏–µ HTTP server (–ø–µ—Ä–µ—Å—Ç–∞—ë–º –ø—Ä–∏–Ω–∏–º–∞—Ç—å –Ω–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
  - –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –ë–î
  - –¢–∞–π–º–∞—É—Ç –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (30 —Å–µ–∫)
  ```typescript
  // –ë–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è graceful shutdown
  async function gracefulShutdown(signal: string) {
    logger.info(`${signal} received, starting graceful shutdown...`);
    
    const forceShutdownTimer = setTimeout(() => {
      logger.error('Shutdown timeout, forcing exit');
      process.exit(1);
    }, 30000);
    
    try {
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º HTTP server
      await new Promise((resolve) => server.close(resolve));
      logger.info('HTTP server closed');
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ë–î
      await db.$disconnect();
      logger.info('Database closed');
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º Redis
      await redisClient.quit();
      logger.info('Redis disconnected');
      
      clearTimeout(forceShutdownTimer);
      process.exit(0);
    } catch (error) {
      logger.error({ error }, 'Shutdown error');
      process.exit(1);
    }
  }
  
  process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
  process.on('SIGINT', () => gracefulShutdown('SIGINT'));
  ```
- **SQL Injection –∑–∞—â–∏—Ç–∞**: –¢–æ–ª—å–∫–æ prepared statements/ORM
- **Rate limiting**: –ó–∞—â–∏—Ç–∞ –æ—Ç DDoS —Å Redis
  - **–í—ã–±–æ—Ä Redis** –≤–º–µ—Å—Ç–æ in-memory –∏–∑-–∑–∞:
    - üîÑ –†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ (multiple instances)
    - üíæ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
    - üéØ –û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    - ‚ö° –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (microsecond latency)
  - **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏:** `express-rate-limit` + `rate-limit-redis`
  - **–°—Ç—Ä–∞—Ç–µ–≥–∏—è –ª–∏–º–∏—Ç–æ–≤:**
    - API endpoints: 100 –∑–∞–ø—Ä–æ—Å–æ–≤ / 15 –º–∏–Ω—É—Ç
    - Payment creation: 10 –ø–ª–∞—Ç–µ–∂–µ–π / —á–∞—Å / IP (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–±–æ—Ä–∞ –∫–∞—Ä—Ç –∏ —Ñ—Ä–æ–¥–æ–≤—ã—Ö –∞—Ç–∞–∫)
    - **Webhooks: –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º rate limiter** (—Å–º. –∑–∞—â–∏—Ç—É webhooks –Ω–∏–∂–µ)
  ```typescript
  // Rate limiter —Å Redis store
  import rateLimit from 'express-rate-limit';
  import RedisStore from 'rate-limit-redis';
  import { createClient } from 'redis';
  
  const redisClient = createClient({
    url: process.env.REDIS_URL || 'redis://redis:6379'
  });
  await redisClient.connect();
  
  // Payment creation limiter (—Å—Ç—Ä–æ–≥–∏–π)
  export const paymentLimiter = rateLimit({
    windowMs: 60 * 60 * 1000, // 1 —á–∞—Å
    max: 10,
    store: new RedisStore({
      client: redisClient,
      prefix: 'rl:payment:',
    }),
    keyGenerator: (req) => `${req.ip}:${req.body?.userId}`,
    handler: (req, res) => {
      logger.warn({ ip: req.ip }, 'Payment rate limit exceeded');
      res.status(429).json({
        error: 'Too many payment attempts',
        message: 'Maximum 10 payments per hour',
      });
    },
  });
  
  // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ routes
  app.post('/api/payments', paymentLimiter, createPaymentController);
  ```

#### üîç –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å
- **Health check endpoint**: `GET /health`
  ```json
  {
    "status": "ok",
    "timestamp": "2024-01-20T10:00:00Z",
    "version": "1.0.0",
    "checks": {
      "database": "ok",
      "yookassa": "ok"
    }
  }
  ```
- **Correlation IDs**: –î–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ (—Å–º. —Ä–∞–∑–¥–µ–ª "–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ")

### 2.2. –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: Test-Driven Development (TDD)

**‚ùó –¢–µ—Å—Ç—ã –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´, –Ω–µ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã**

#### –ü–æ–¥—Ö–æ–¥ TDD:
1. **Red**: –ù–∞–ø–∏—Å–∞—Ç—å failing test
2. **Green**: –ù–∞–ø–∏—Å–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞
3. **Refactor**: –£–ª—É—á—à–∏—Ç—å –∫–æ–¥, —Å–æ—Ö—Ä–∞–Ω—è—è —Ç–µ—Å—Ç—ã –∑–µ–ª–µ–Ω—ã–º–∏

#### –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏:

**Unit Tests** (–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ):
- ‚úÖ `YookassaService` - –≤—Å–µ –º–µ—Ç–æ–¥—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å API
  - –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
  - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
  - Retry –ª–æ–≥–∏–∫–∞
- ‚úÖ `PaymentService` - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
  - State machine –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
  - –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook —Å–æ–±—ã—Ç–∏–π
- ‚úÖ `WebhookValidator` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏
  - IP validation
  - Signature verification
- ‚úÖ –£—Ç–∏–ª–∏—Ç—ã (idempotence, logger helpers)

#### –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- **Test Runner**: Jest + ts-jest
- **HTTP Mocking**: axios-mock-adapter (–¥–ª—è –º–æ–∫–æ–≤ API –Æ–ö–∞—Å—Å—ã - –ë–ï–ó —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
- **DB Mocking**: jest.mock() –¥–ª—è Prisma (–±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –ë–î)
- **Coverage**: –ú–∏–Ω–∏–º—É–º 80% –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–æ–π –ª–æ–≥–∏–∫–∏

**‚ùó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –¢–æ–ª—å–∫–æ Unit —Ç–µ—Å—Ç—ã**

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã **–Ω–µ –≤–∫–ª—é—á–µ–Ω—ã** –≤ –ø—Ä–æ–µ–∫—Ç –Ω–∞ –¥–∞–Ω–Ω–æ–π —Å—Ç–∞–¥–∏–∏:
- ‚ö†Ô∏è **–ü–µ—Ä–µ—É—Å–ª–æ–∂–Ω–µ–Ω–∏–µ**: –¢—Ä–µ–±—É—é—Ç test PostgreSQL, Docker setup, cleanup –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
- ‚è±Ô∏è **–í—Ä–µ–º—è**: Unit —Ç–µ—Å—Ç—ã (~2-3—á) vs +Integration (~+4-6—á) - –∏–∑–±—ã—Ç–æ—á–Ω–æ –¥–ª—è MVP
- ‚úÖ **–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å**: Unit —Ç–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, edge cases, state machine
- üöÄ **–°–∫–æ—Ä–æ—Å—Ç—å**: –í—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ (<5s), –Ω–µ —Ç—Ä–µ–±—É—é—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
npm install --save-dev jest @types/jest ts-jest
npm install --save-dev axios-mock-adapter
```

#### –ü—Ä–∏–º–µ—Ä—ã Unit —Ç–µ—Å—Ç–æ–≤:

**1. YookassaService** (—Å axios-mock-adapter):
```typescript
import MockAdapter from 'axios-mock-adapter';
import axios from 'axios';
import { YookassaService } from '@/services/yookassa.service';

describe('YookassaService', () => {
  const mockAxios = new MockAdapter(axios);
  let service: YookassaService;

  beforeEach(() => {
    service = new YookassaService({ shopId: 'test', secretKey: 'test' });
    mockAxios.reset();
  });

  describe('createPayment', () => {
    it('should create payment - NO REAL HTTP REQUEST', async () => {
      const expectedResponse = {
        id: 'payment-123',
        status: 'pending',
      };

      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º mock - axios.post() –±—É–¥–µ—Ç –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω
      mockAxios
        .onPost('https://api.yookassa.ru/v3/payments')
        .reply(200, expectedResponse);

      // ‚ùå –†–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ù–ï —É—Ö–æ–¥–∏—Ç –∫ API –Æ–ö–∞—Å—Å—ã
      // ‚úÖ mockAxios –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç expectedResponse
      const result = await service.createPayment(
        { amount: { value: '100', currency: 'RUB' } },
        'idempotence-key'
      );

      expect(result.id).toBe('payment-123');
      expect(mockAxios.history.post.length).toBe(1); // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ "–∑–∞–ø—Ä–æ—Å" –±—ã–ª
    });

    it('should retry on 500 error', async () => {
      mockAxios
        .onPost('https://api.yookassa.ru/v3/payments')
        .replyOnce(500) // –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ - –æ—à–∏–±–∫–∞
        .onPost('https://api.yookassa.ru/v3/payments')
        .replyOnce(200, { id: 'payment-123' }); // –í—Ç–æ—Ä–∞—è - —É—Å–ø–µ—Ö

      const result = await service.createPayment({}, 'key');
      
      expect(result.id).toBe('payment-123');
      expect(mockAxios.history.post.length).toBe(2); // 2 –ø–æ–ø—ã—Ç–∫–∏
    });

    it('should throw on timeout', async () => {
      mockAxios.onPost('https://api.yookassa.ru/v3/payments').timeout();

      await expect(service.createPayment({}, 'key')).rejects.toThrow();
    });
  });
});
```

**2. PaymentService** (state machine):
```typescript
import { PaymentService } from '@/services/payment.service';
import { prisma } from '@/config/database';

jest.mock('@/config/database');

describe('PaymentService', () => {
  describe('handleWebhookEvent', () => {
    it('should transition from PENDING to SUCCEEDED', async () => {
      (prisma.payments.findUnique as jest.Mock).mockResolvedValue({
        id: 'payment-123',
        status: 'PENDING',
      });

      (prisma.payments.update as jest.Mock).mockResolvedValue({
        id: 'payment-123',
        status: 'SUCCEEDED',
      });

      const result = await service.handleWebhookEvent({
        event: 'payment.succeeded',
        object: { id: 'yookassa-123', status: 'succeeded' },
      });

      expect(result.status).toBe('SUCCEEDED');
    });

    it('should reject invalid transition SUCCEEDED -> CANCELED', async () => {
      (prisma.payments.findUnique as jest.Mock).mockResolvedValue({
        status: 'SUCCEEDED', // –£–∂–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
      });

      await expect(
        service.handleWebhookEvent({
          event: 'payment.canceled',
          object: { status: 'canceled' },
        })
      ).rejects.toThrow('Invalid transition');
    });
  });
});
```

**3. WebhookValidator** (IP validation):
```typescript
import { validateWebhookIP } from '@/middlewares/webhook-validator';

describe('WebhookValidator', () => {
  it('should allow YooKassa IPs', () => {
    const req = { ip: '185.71.76.1' } as Request;
    const next = jest.fn();

    validateWebhookIP(req, {} as Response, next);

    expect(next).toHaveBeenCalled(); // –†–∞–∑—Ä–µ—à–µ–Ω–æ
  });

  it('should block non-YooKassa IPs', () => {
    const req = { ip: '1.2.3.4' } as Request;
    const res = { status: jest.fn().mockReturnThis(), json: jest.fn() };
    const next = jest.fn();

    validateWebhookIP(req, res as any, next);

    expect(res.status).toHaveBeenCalledWith(403);
    expect(next).not.toHaveBeenCalled(); // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
  });
});
```

### 2.3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è

#### –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ –ø—Ä–æ edge cases –Æ–ö–∞—Å—Å—ã
```typescript
// ‚ö†Ô∏è IMPORTANT: –Æ–ö–∞—Å—Å–∞ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å webhook –î–û –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ POST /payments
// –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å webhook –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ
async function handleWebhook(notification: YookassaNotification) {
  // ...
}

// üêõ EDGE CASE: –°—Ç–∞—Ç—É—Å –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ –∏–∑ webhook –∏ polling
// –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ (Idempotent update) –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è race condition
async function updatePaymentStatus(paymentId: string, newStatus: string) {
  return await db.transaction(async (tx) => {
    const payment = await tx.payments.findUnique({
      where: { id: paymentId }
    });
    
    if (payment.status === newStatus) return payment;
    if (isFinalStatus(payment.status)) return payment;
    // ...
  });
}

// üìù NOTE: TTL 24 —á–∞—Å–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –Æ–ö–∞—Å—Å—ã
// –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á (UUID v4)
function generateIdempotenceKey(): string {
  return uuid(); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —á–∏—Å—Ç—ã–π UUID v4
}
```

#### –ü—Ä–∏–º–µ—Ä—ã —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –æ—à–∏–±–æ–∫ –∏ –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∞
–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `docs/ERROR_SCENARIOS.md`:
```markdown
# –°—Ü–µ–Ω–∞—Ä–∏–∏ –æ—à–∏–±–æ–∫ –∏ –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∞

## 1. –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞
**–ü—Ä–æ–±–ª–µ–º–∞**: –Æ–ö–∞—Å—Å–∞ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥
**–†–µ—à–µ–Ω–∏–µ**:
1. –ü–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å —Ç–µ–º –∂–µ idempotence-key (retry —Å backoff)
2. –õ–æ–≥–∏—Ä—É–µ–º timeout —Å correlation ID
3. –ï—Å–ª–∏ –≤—Å–µ retry –∏—Å—á–µ—Ä–ø–∞–Ω—ã ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 503 (Service Unavailable)
4. –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å —Å —Ç–µ–º –∂–µ –∫–ª—é—á–æ–º –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ GET /payments/:id

## 2. HTTP 500 –æ—Ç –Æ–ö–∞—Å—Å—ã
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ, —Å–æ–∑–¥–∞–Ω –ø–ª–∞—Ç–µ–∂ –∏–ª–∏ –Ω–µ—Ç
**–†–µ—à–µ–Ω–∏–µ**:
1. –ü–æ–≤—Ç–æ—Ä—è–µ–º POST —Å —Ç–µ–º –∂–µ idempotence-key
2. –ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ –±—ã–ª —Å–æ–∑–¥–∞–Ω ‚Äî –Æ–ö–∞—Å—Å–∞ –≤–µ—Ä–Ω—ë—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
3. –ï—Å–ª–∏ –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω ‚Äî –Æ–ö–∞—Å—Å–∞ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–π

## 3. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ webhook
**–ü—Ä–æ–±–ª–µ–º–∞**: –Æ–ö–∞—Å—Å–∞ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–¥–∏–Ω webhook –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
**–†–µ—à–µ–Ω–∏–µ**:
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ (state machine –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å)
- –§–∏–Ω–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã (succeeded/canceled) –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è
- –í–æ–∑–≤—Ä–∞—â–∞–µ–º 200 OK –¥–∞–∂–µ –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ

## 4. Webhook –ø—Ä–∏—à–µ–ª —Ä–∞–Ω—å—à–µ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ POST
**–ü—Ä–æ–±–ª–µ–º–∞**: Race condition ‚Äî webhook –æ—Ç –Æ–ö–∞—Å—Å—ã –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ —Ä–∞–Ω—å—à–µ, —á–µ–º POST /api/payments –≤–µ—Ä–Ω—ë—Ç –æ—Ç–≤–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç –ø–ª–∞—Ç—ë–∂ –≤ –ë–î.

**–†–µ—à–µ–Ω–∏–µ**: –°–º. –ø–æ–¥—Ä–æ–±–Ω—É—é –ª–æ–≥–∏–∫—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –≤ **¬ß7.2 Webhook Security**. –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏–Ω—Ü–∏–ø ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –Æ–ö–∞—Å—Å—ã –∫–∞–∫ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏—Å—Ç–∏–Ω—ã.
```

---

## üéØ 3. SCOPE –ü–†–û–ï–ö–¢–ê (–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)

### –ß—Ç–æ –í–ö–õ–Æ–ß–ê–ï–ú:
‚úÖ **Core —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –æ–ø–ª–∞—Ç—ã:**
- POST `/api/payments` - –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
- GET `/api/payments/:id` - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç–µ–∂–µ
- POST `/api/webhooks/yookassa` - –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç –Æ–ö–∞—Å—Å—ã

‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è webhook-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

‚úÖ **–ó–∞—â–∏—Ç–∞ –ë–î:**
- –ú–∏–≥—Ä–∞—Ü–∏–∏
- –ò–Ω–¥–µ–∫—Å—ã
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (constraints)
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### –ß—Ç–æ –ù–ï –≤–∫–ª—é—á–∞–µ–º (out of scope):
‚ùå GET `/payments` - —Å–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π (–∞–¥–º–∏–Ω—Å–∫–∞—è —Ñ–∏—á–∞)
‚ùå POST `/refunds` - —Å–æ–∑–¥–∞–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ –¢–ó)
‚ùå Frontend —á–∞—Å—Ç—å
‚ùå –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å)
‚ùå Admin panel

---

## üîë 3. –ö–õ–Æ–ß–ï–í–´–ï API –ú–ï–¢–û–î–´ –Æ–ö–ê–°–°–´

### 3.1. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

#### POST `https://api.yookassa.ru/v3/payments`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞  
**–¢—Ä–µ–±—É–µ—Ç:**
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: HTTP Basic Auth (shopId:secretKey)
- Idempotence-Key (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
- Body: `{ amount, capture, confirmation, description, metadata }`

**–í–∞–∂–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `capture: true` - —Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã (–≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –Ω–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏)
- `confirmation.type: "redirect"` - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã
- `confirmation.return_url` - URL –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

#### GET `https://api.yookassa.ru/v3/payments/{payment_id}`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞  
**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ webhook
- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–¥–µ–ª—å–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### 3.2. Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
**URL:** –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –Æ–ö–∞—Å—Å—ã  
**–§–æ—Ä–º–∞—Ç:** POST –∑–∞–ø—Ä–æ—Å –æ—Ç –Æ–ö–∞—Å—Å—ã –Ω–∞ –Ω–∞—à endpoint

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
```json
{
  "type": "notification",
  "event": "payment.succeeded|payment.canceled",
  "object": { /* –æ–±—ä–µ–∫—Ç –ø–ª–∞—Ç–µ–∂–∞ */ }
}
```

**–ö—Ä–∏—Ç–∏—á–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- ‚úÖ –û—Ç–≤–µ—á–∞—Ç—å HTTP 200 –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å (IP whitelist + GET verification)
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
- ‚è±Ô∏è –Æ–ö–∞—Å—Å–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ

---

## ‚ö†Ô∏è 4. –û–°–û–ë–ï–ù–ù–û–°–¢–ò –ò –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

> üìå **–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ TTL –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏:**
> ```typescript
> // src/config/constants.ts
> export const YOOKASSA_IDEMPOTENCY_TTL = 24 * 60 * 60; // 24 —á–∞—Å–∞ (—Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –Æ–ö–∞—Å—Å—ã)
> ```
> –í—Å–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è "TTL 24 —á–∞—Å–∞" –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ —ç—Ç—É –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É.

### 4.1. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (double-click, network retry) –º–æ–≥—É—Ç —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏ –ø–ª–∞—Ç–µ–∂–µ–π.

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
- üîë **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞:** –ö–ª—é—á –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω, **—Å—Ç—Ä–æ–≥–æ UUID v4** (–≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ middleware)
- ‚úÖ **–§–æ—Ä–º–∞—Ç:** `^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$`
- üíæ **–•—Ä–∞–Ω–µ–Ω–∏–µ:** Redis (–Ω–µ PostgreSQL) - –±—ã—Å—Ç—Ä–µ–µ, TTL –∏–∑ –∫–æ—Ä–æ–±–∫–∏, –∞—Ç–æ–º–∞—Ä–Ω—ã–π SET NX
- ‚è±Ô∏è **TTL:** `YOOKASSA_IDEMPOTENCY_TTL` (24 —á–∞—Å–∞)
- üîÑ **–ü—Ä–æ–≤–µ—Ä–∫–∞:** –î–û –∑–∞–ø—Ä–æ—Å–∞ –∫ –Æ–ö–∞—Å—Å–µ (—ç–∫–æ–Ω–æ–º–∏–º API calls)
- üõ°Ô∏è **–í–∞–ª–∏–¥–∞—Ü–∏—è:** Hash request body (–∏—Å–ø–æ–ª—å–∑—É—è `json-stable-stringify`) –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–¥–º–µ–Ω—ã –¥–∞–Ω–Ω—ã—Ö

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```typescript
// 1. Middleware –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–ª—é—á–∞
function extractIdempotencyKey(req: Request, res: Response, next: NextFunction) {
  const key = req.headers['idempotence-key'] as string;
  if (!key) return res.status(400).json({ error: 'Idempotence-Key header is required' });
  if (!UUID_V4_REGEX.test(key)) return res.status(400).json({ error: 'Idempotence-Key must be UUID v4' });
  req.idempotencyKey = key;
  next();
}

// 2. –õ–æ–≥–∏–∫–∞ –≤ —Å–µ—Ä–≤–∏—Å–µ/–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ
async function createPayment(req, res) {
  const key = req.idempotencyKey;
  const redisKey = `idempotency:${key}`;
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è —Ö–µ—à–∞)
  const currentHash = crypto.createHash('sha256')
    .update(stringify(req.body)) // json-stable-stringify
    .digest('hex');

  const cached = await redis.get(redisKey);
  if (cached) {
    const data = JSON.parse(cached);
    if (currentHash !== data.requestHash) {
      return res.status(409).json({ error: 'Idempotency key conflict' });
    }
    return res.status(200).json(data.payment);
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ –≤ –Æ–ö–∞—Å—Å–µ
  const yookassaPayment = await yookassa.createPayment(req.body, key);
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π Race Condition (Unique Constraint)
  let payment;
  try {
    payment = await prisma.payments.create({
      data: { yookassaPaymentId: yookassaPayment.id, ...req.body }
    });
  } catch (e) {
    if (e.code === 'P2002') {
       payment = await prisma.payments.findUnique({ where: { yookassaPaymentId: yookassaPayment.id } });
    } else throw e;
  }

  // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
  await redis.set(redisKey, JSON.stringify({ payment, requestHash: currentHash }), 'EX', 86400);
  
  return res.status(201).json(payment);
}
```

**Edge Cases –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è:**

1. **Race Condition** (2 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, t=0ms):
   - **–ü—Ä–æ–±–ª–µ–º–∞:** –û–±–∞ –ø–æ—Ç–æ–∫–∞ —á–∏—Ç–∞—é—Ç Redis ‚Üí –Ω–µ –Ω–∞—Ö–æ–¥—è—Ç –∫–ª—é—á ‚Üí –æ–±–∞ —Å–æ–∑–¥–∞—é—Ç –ø–ª–∞—Ç–µ–∂–∏ –≤ –Æ–ö–∞—Å—Å–µ
   - **–†–µ—à–µ–Ω–∏–µ (–º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞):**
     - –Æ–ö–∞—Å—Å–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (TTL 24 —á–∞—Å–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)
     - `yookassa_payment_id UNIQUE` constraint –≤ –ë–î
     - –í—Ç–æ—Ä–æ–π –ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–∏—Ç constraint violation ‚Üí –ø—Ä–æ—á–∏—Ç–∞–µ—Ç –ø–ª–∞—Ç—ë–∂ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞
   ```typescript
   try {
     // –û–±–∞ –ø–æ—Ç–æ–∫–∞ —Å–æ–∑–¥–∞—é—Ç –≤ –Æ–ö–∞—Å—Å–µ —Å –æ–¥–Ω–∏–º –∫–ª—é—á–æ–º
     // –Æ–ö–∞—Å—Å–∞ –≤–µ—Ä–Ω—ë—Ç –û–î–ò–ù –ò –¢–û–¢ –ñ–ï payment ID –æ–±–æ–∏–º
     
     await prisma.payments.create({
       data: { yookassaPaymentId: yookassaPayment.id, ... }
     });
   } catch (error) {
     if (error.code === 'P2002') { // Unique constraint
       // –î—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ —É–∂–µ —Å–æ–∑–¥–∞–ª - —á–∏—Ç–∞–µ–º –µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
       const existing = await prisma.payments.findUnique({
         where: { yookassaPaymentId: yookassaPayment.id }
       });
       return existing;
     }
   }
   ```
   - **–í—ã–≤–æ–¥:** –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ü–û–°–õ–ï —Å–æ–∑–¥–∞–Ω–∏—è ‚Üí race condition –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞

2. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç –¥–∞–Ω–Ω—ã—Ö** (—Ç–æ—Ç –∂–µ –∫–ª—é—á, –¥—Ä—É–≥–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞):
   - **–ü—Ä–æ–±–ª–µ–º–∞:** –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —á—É–∂–æ–π –∫–ª—é—á —Å –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (—Å—É–º–º–∞, userId)
   - **–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –ë–ï–ó –∑–∞—â–∏—Ç—ã:**
     - DoS: –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ "–æ—Ç—Ä–∞–≤–ª—è–µ—Ç" –∫–ª—é—á–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —Å—É–º–º–∞–º–∏
     - User —Ö–æ—Ç–µ–ª 100‚ÇΩ, –ø–æ–ª—É—á–∏–ª —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É 1‚ÇΩ
     - –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Ç–µ—Ä–∏: –æ–ø–ª–∞—Ç–∞ –º–µ–Ω—å—à–µ–≥–æ –ø–ª–∞–Ω–∞ –≤–º–µ—Å—Ç–æ –±–æ–ª—å—à–µ–≥–æ
   - **–†–µ—à–µ–Ω–∏–µ:** Hash request body + –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ
   ```typescript
   const currentHash = crypto.createHash('sha256')
     .update(JSON.stringify(req.body))
     .digest('hex');
   
   if (cached.requestHash !== currentHash) {
     return res.status(409).json({ 
       error: 'Idempotency key conflict',
       message: 'Same key used with different request body'
     });
   }
   ```

3. **–ß–∞—Å—Ç–∏—á–Ω—ã–π —É—Å–ø–µ—Ö** (–Æ–ö–∞—Å—Å–∞ —Å–æ–∑–¥–∞–ª–∞ –ø–ª–∞—Ç—ë–∂, –Ω–æ –Ω–∞—à —Å–µ—Ä–≤–µ—Ä —É–ø–∞–ª –¥–æ –∑–∞–ø–∏—Å–∏ –≤ Redis):
   - **–ü—Ä–æ–±–ª–µ–º–∞:** –ü–ª–∞—Ç—ë–∂ –≤ –Æ–ö–∞—Å—Å–µ –µ—Å—Ç—å, —É –Ω–∞—Å –Ω–µ—Ç, –∫–ª—é—á–∞ –≤ Redis –Ω–µ—Ç.
   - **–†–µ—à–µ–Ω–∏–µ:** Webhook –æ—Ç –Æ–ö–∞—Å—Å—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç –¥–∞–Ω–Ω—ã–µ (—Å–º. **¬ß7.2 Webhook Security**).

4. **–§–µ–π–∫–æ–≤—ã–π webhook** (–∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø–æ–¥–¥–µ–ª–∞–ª IP –∏ webhook):
   - **–ü—Ä–æ–±–ª–µ–º–∞:** –°–æ–∑–¥–∞—ë—Ç—Å—è –ø–ª–∞—Ç—ë–∂ –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ –Æ–ö–∞—Å—Å–µ
   - **–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –ë–ï–ó –∑–∞—â–∏—Ç—ã:**
     - –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ (—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Ç–µ—Ä–∏)
     - –ú–∞—Å—Å–æ–≤–∞—è –∞—Ç–∞–∫–∞ (—Ç—ã—Å—è—á–∏ —Ñ–µ–π–∫–æ–≤—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)
     - Data corruption (—Å–≤–µ—Ä–∫–∞ —Å –Æ–ö–∞—Å—Å–æ–π –Ω–µ —Å–æ–π–¥—ë—Ç—Å—è)
   - **–†–µ—à–µ–Ω–∏–µ (–º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞):**
     1. **IP Whitelist** ‚Üí 403 Forbidden (–±–ª–æ–∫–∏—Ä—É–µ—Ç 99% –∞—Ç–∞–∫)
     2. **GET Verification** –∫ –Æ–ö–∞—Å—Å–µ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø–ª–∞—Ç—ë–∂ —Ä–µ–∞–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
     3. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞** ‚Üí –µ—Å–ª–∏ webhook –ø—Ä–∏—à–µ–ª —Ä–∞–Ω—å—à–µ POST
     4. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** ‚Üí state machine + Redis tracking
   
   - ‚úÖ **–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å –∫–æ–¥–æ–º:** –°–º. ¬ß7.2 Webhook Security

5. **–ö–ª–∏–µ–Ω—Ç –Ω–µ –ø–µ—Ä–µ–¥–∞–ª Idempotence-Key**:
   - **–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –¥—É–±–ª–µ–π
   - **–†–µ—à–µ–Ω–∏–µ:** –í–æ–∑–≤—Ä–∞—â–∞—Ç—å 400 Bad Request (–∫–ª—é—á –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)
   ```typescript
   if (!req.headers['idempotence-key']) {
     return res.status(400).json({ error: 'Idempotence-Key required' });
   }
   ```

6. **–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞**:
   - **–ü—Ä–æ–±–ª–µ–º–∞:** –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ–¥–∞–ª –Ω–µ UUID ("abc", "123")
   - **–†–µ—à–µ–Ω–∏–µ:** –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –≤ middleware
   ```typescript
   const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
   if (!uuidRegex.test(key)) {
     return res.status(400).json({ error: 'Invalid key format (UUID v4 required)' });
   }
   ```

7. **–ò—Å—Ç—ë–∫—à–∏–π –∫–ª—é—á (TTL expired)**:
   - **–ü—Ä–æ–±–ª–µ–º–∞:** –ö–ª–∏–µ–Ω—Ç –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
   - **–†–µ—à–µ–Ω–∏–µ:** Redis –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏–ª ‚Üí —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂ (–∫–∞–∫ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ)
   - **–ü–æ–≤–µ–¥–µ–Ω–∏–µ:** –ù–æ—Ä–º–∞–ª—å–Ω–æ, –æ–ø–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—à–µ 24—á —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–æ–≤–æ–π (industry standard: Stripe, AWS)
   - **Note:** TTL 24 —á–∞—Å–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –Æ–ö–∞—Å—Å—ã

**‚ö†Ô∏è –í–ê–ñ–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Edge Cases**

–í—Å–µ edge cases **—Å–æ–≤–º–µ—Å—Ç–∏–º—ã –∏ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç**, –Ω–æ —Ç—Ä–µ–±—É—é—Ç **—Å—Ç—Ä–æ–≥–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** –≤ –∫–æ–¥–µ:

**–ü–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è Payment API:**
```
1. Middleware: extractIdempotencyKey
   ‚îú‚îÄ Case 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–ª—é—á–∞ (400 –µ—Å–ª–∏ –Ω–µ—Ç)
   ‚îî‚îÄ Case 6: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ UUID (400 –µ—Å–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω)

2. Controller: createPayment
   ‚îú‚îÄ Case 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Redis (TTL expired ‚Üí –∫–ª—é—á–∞ –Ω–µ—Ç)
   ‚îú‚îÄ Case 2: Hash validation (409 –µ—Å–ª–∏ mismatch)
   ‚îú‚îÄ YooKassa API call
   ‚îú‚îÄ Case 1: DB INSERT + unique constraint (race condition)
   ‚îî‚îÄ Redis cache

‚úÖ –ö—Ä–∏—Ç–∏—á–Ω–æ: –í–∞–ª–∏–¥–∞—Ü–∏—è (5,6) –î–û –ø—Ä–æ–≤–µ—Ä–∫–∏ Redis (2,7) –î–û —Å–æ–∑–¥–∞–Ω–∏—è (1)
```

**–ü–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è Webhook:**
```
1. Webhook handler: handleYookassaWebhook
   ‚îú‚îÄ Case 4a: IP Whitelist (403 –µ—Å–ª–∏ –Ω–µ –Æ–ö–∞—Å—Å–∞)
   ‚îú‚îÄ Case 4b: GET verification –∫ –Æ–ö–∞—Å—Å–µ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ—Å–ª–∏ fake)
   ‚îî‚îÄ Case 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤ –ë–î (—Å–æ–∑–¥–∞—ë–º –µ—Å–ª–∏ –Ω–µ—Ç)

‚úÖ –ö—Ä–∏—Ç–∏—á–Ω–æ: –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è (4) –î–û –æ–±—Ä–∞–±–æ—Ç–∫–∏ (3)
```

**–ü–æ—á–µ–º—É –ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω:**
- ‚ùå **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:** –ü—Ä–æ–≤–µ—Ä—è—Ç—å hash –î–û –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∞ ‚Üí –º–æ–∂–µ–º —É–ø–∞—Å—Ç—å –Ω–∞ invalid key
- ‚ùå **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:** –°–æ–∑–¥–∞–≤–∞—Ç—å –ø–ª–∞—Ç—ë–∂ –î–û –ø—Ä–æ–≤–µ—Ä–∫–∏ hash ‚Üí —Å–æ–∑–¥–∞–¥–∏–º —Å –Ω–µ–≤–µ—Ä–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- ‚ùå **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å webhook –î–û IP/GET –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Üí —Å–æ–∑–¥–∞–¥–∏–º —Ñ–µ–π–∫–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ:** –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Üí –º–µ–¥–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Üí side effects (—Å–æ–∑–¥–∞–Ω–∏–µ)

**–ü—Ä–∏–Ω—Ü–∏–ø: "Fail fast, succeed slow"**
- –°–Ω–∞—á–∞–ª–∞ –æ—Ç—Å–µ–∏–≤–∞–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (–±—ã—Å—Ç—Ä–æ, –±–µ–∑ side effects)
- –ü–æ—Ç–æ–º –¥–µ–ª–∞–µ–º –¥–æ—Ä–æ–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (API calls, DB writes)

### 4.2. –°—Ç–∞—Ç—É—Å—ã –ø–ª–∞—Ç–µ–∂–µ–π –∏ state machine

> üìå **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –í –Ω–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ—Å—Ç–∞–¥–∏–π–Ω–∞—è –æ–ø–ª–∞—Ç–∞** (`capture: true`)

**–°—Ç–∞—Ç—É—Å—ã –ø–ª–∞—Ç–µ–∂–µ–π:**
- `pending` - –ø–ª–∞—Ç—ë–∂ —Å–æ–∑–¥–∞–Ω, –æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- `succeeded` - **[FINAL]** —É—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω –∏ –∑–∞–≤–µ—Ä—à—ë–Ω (–Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–π)
- `canceled` - **[FINAL]** –æ—Ç–º–µ–Ω—ë–Ω (–Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–π)

**–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è):**
```
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ   pending   ‚îÇ ‚Üê –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ (capture: true)
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚ñº               ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇsucceeded‚îÇ      ‚îÇcanceled ‚îÇ
    ‚îÇ [FINAL] ‚îÇ      ‚îÇ [FINAL] ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–î–æ–ø—É—Å—Ç–∏–º—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã:**
- `pending` ‚Üí `succeeded` (—É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞)
- `pending` ‚Üí `canceled` (–æ—Ç–º–µ–Ω–∞/–æ—à–∏–±–∫–∞/—Ç–∞–π–º–∞—É—Ç)

**‚ùå –ó–ê–ü–†–ï–©–Å–ù–ù–´–ï –ø–µ—Ä–µ—Ö–æ–¥—ã:**
- `succeeded` ‚Üí –ª—é–±–æ–π (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å!)
- `canceled` ‚Üí –ª—é–±–æ–π (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å!)
- –î–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Refund API, –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞

**–ü—Ä–æ–±–ª–µ–º–∞: Duplicate Webhooks (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è)**

–í –Ω–∞—à–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ **–ù–ï–¢** –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ concurrent updates (webhook vs polling), –ø–æ—Ç–æ–º—É —á—Ç–æ:
- ‚úÖ Polling —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ webhook (GET –∑–∞–ø—Ä–æ—Å –≤–Ω—É—Ç—Ä–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞)
- ‚úÖ –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ GET API, –Ω–µ –∏–∑ webhook body
- ‚úÖ –ö–æ–Ω—Ñ–ª–∏–∫—Ç –≤–æ–∑–º–æ–∂–µ–Ω —Ç–æ–ª—å–∫–æ –ø—Ä–∏ duplicate webhooks (–Æ–ö–∞—Å—Å–∞ retry –∏–ª–∏ –±—ã—Å—Ç—Ä–∞—è —Å–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–æ–≤)

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```typescript
Thread A: Webhook payment.succeeded (–ø–æ–ª—É—á–µ–Ω —Ä–∞–Ω—å—à–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–æ)
          GET /payments/123 ‚Üí succeeded

Thread B: Webhook payment.canceled (–ø–æ–ª—É—á–µ–Ω –ø–æ–∑–∂–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–æ)
          GET /payments/123 ‚Üí canceled
          UPDATE status = 'canceled' ‚úÖ

Thread A: (–ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç)
          UPDATE status = 'succeeded' ‚ùå –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞–ª canceled!
```

**–†–µ—à–µ–Ω–∏–µ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ–µ –¥–ª—è –Ω–∞—à–µ–≥–æ —Å–ª—É—á–∞—è):**

1. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
2. **–ó–∞—â–∏—Ç–∞ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤** - –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º succeeded/canceled
3. **State machine –≤–∞–ª–∏–¥–∞—Ü–∏—è** - –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–ø—É—Å—Ç–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥–æ–≤

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
// State Machine –≤–∞–ª–∏–¥–∞—Ç–æ—Ä (–æ–¥–Ω–æ—Å—Ç–∞–¥–∏–π–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏)
class PaymentStateMachine {
  private static readonly TRANSITIONS = {
    pending: ['succeeded', 'canceled'],
    succeeded: [], // –§–∏–Ω–∞–ª—å–Ω—ã–π - –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è
    canceled: [],  // –§–∏–Ω–∞–ª—å–Ω—ã–π - –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è
  };

  static canTransition(from: string, to: string): boolean {
    if (from === to) return true; // –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
    return this.TRANSITIONS[from]?.includes(to) || false;
  }

  static isFinal(status: string): boolean {
    return ['succeeded', 'canceled'].includes(status);
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
async function updatePaymentStatusFromWebhook(
  paymentId: string,
  newStatus: string
) {
  const current = await prisma.payments.findUnique({ where: { id: paymentId } });

  // 1. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
  if (current.status === newStatus) {
    return current; // –£–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
  }

  // 2. –ó–∞—â–∏—Ç–∞ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
  if (PaymentStateMachine.isFinal(current.status)) {
    logger.warn({ paymentId, currentStatus: current.status, attemptedStatus: newStatus },
      'Attempted to modify final status - ignored'
    );
    return current;
  }

  // 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞
  if (!PaymentStateMachine.canTransition(current.status, newStatus)) {
    throw new Error(`Invalid transition: ${current.status} ‚Üí ${newStatus}`);
  }

  // 4. –û–±–Ω–æ–≤–ª—è–µ–º
  return await prisma.payments.update({
    where: { id: paymentId },
    data: { status: newStatus, updatedAt: new Date() },
  });
}
```

**–ü–æ—á–µ–º—É –ù–ï –Ω—É–∂–Ω—ã —Å–ª–æ–∂–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã (optimistic/pessimistic locking):**
- ‚úÖ Polling —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–Ω–µ –∫–æ–Ω–∫—É—Ä–∏—Ä—É–µ—Ç —Å webhook)
- ‚úÖ GET API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ Duplicate webhooks - —Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É
- ‚úÖ –ó–∞—â–∏—Ç–∞ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### 4.3. Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ webhook –æ—Ç –Æ–ö–∞—Å—Å—ã:**
```json
{
  "type": "notification",
  "event": "payment.succeeded",
  "object": {
    "id": "payment-123",
    "status": "succeeded",
    "created_at": "2024-01-28T10:00:05Z",
    // ... –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç payment
  }
}
```

**‚ùó –í–∞–∂–Ω–æ:** –Æ–ö–∞—Å—Å–∞ –ù–ï –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ payload (–Ω–µ—Ç notification_id –∏–ª–∏ event_id).

#### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ü–æ—Ä—è–¥–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω

**–°—É—Ç—å:** Webhooks –º–æ–≥—É—Ç –ø—Ä–∏–π—Ç–∏ –ù–ï –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π.

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
```typescript
–†–µ–∞–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –Æ–ö–∞—Å—Å–µ:
t1: Payment created  (pending)
t2: User paid        (succeeded)
t3: Refund created   (refund)

–ü–æ—Ä—è–¥–æ–∫ –ø–æ–ª—É—á–µ–Ω–∏—è webhooks:
t=0s: Webhook #2 (succeeded)  ‚Üê –ü—Ä–∏—à—ë–ª –ü–ï–†–í–´–ú
t=2s: Webhook #1 (pending)    ‚Üê –ü—Ä–∏—à—ë–ª –≤—Ç–æ—Ä—ã–º
t=5s: Webhook #3 (refund)     ‚Üê –ü—Ä–∏—à—ë–ª —Ç—Ä–µ—Ç—å–∏–º

–ë–ï–ó –∑–∞—â–∏—Ç—ã: status –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞–∑–∞–¥! ‚ùå
```

**‚úÖ –ù–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ: GET verification (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)**

```typescript
async function handleWebhook(webhookData) {
  const paymentId = webhookData.object.id;
  
  // ‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ webhook.object –Ω–∞–ø—Ä—è–º—É—é!
  // ‚úÖ –î–µ–ª–∞–µ–º GET –∑–∞–ø—Ä–æ—Å –∫ –Æ–ö–∞—Å—Å–µ
  const actualPayment = await yookassa.getPayment(paymentId);
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–õ–¨–ö–û –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ API
  await updatePaymentStatus(paymentId, actualPayment.status);
}

// –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ out-of-order:
Webhook #2 (succeeded, —Å—Ç–∞—Ä—ã–π):
  ‚Üí GET /payments/123 ‚Üí status = 'succeeded' ‚úÖ
  ‚Üí UPDATE status = 'succeeded'

Webhook #1 (pending, –µ—â—ë —Å—Ç–∞—Ä–µ–µ):
  ‚Üí GET /payments/123 ‚Üí status = 'succeeded' (–∞–∫—Ç—É–∞–ª—å–Ω—ã–π!)
  ‚Üí –ü–æ–ø—ã—Ç–∫–∞ UPDATE status = 'succeeded'
  ‚Üí –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: —É–∂–µ succeeded, skip ‚úÖ

–†–µ–∑—É–ª—å—Ç–∞—Ç: –í—Å–µ–≥–¥–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∏–∑ API!
```

**–ü–æ—á–µ–º—É –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º timestamp –∏–∑ webhook:**
- ‚ùå `created_at` = –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è payment (–Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞)
- ‚ùå `updated_at` –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∏–ª–∏ –±—ã—Ç—å –Ω–µ—Ç–æ—á–Ω—ã–º
- ‚úÖ GET –∑–∞–ø—Ä–æ—Å –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

#### –ü—Ä–æ–±–ª–µ–º–∞ 2: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–°—É—Ç—å:** –Æ–ö–∞—Å—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç at-least-once delivery ‚Üí webhook –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑.

**–ü—Ä–∏—á–∏–Ω—ã –¥—É–±–ª–µ–π:**
- –ù–µ –ø–æ–ª—É—á–∏–ª–∏ 200 OK ‚Üí retry
- –¢–∞–π–º–∞—É—Ç ‚Üí retry
- –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ ‚Üí retry

**‚úÖ –ù–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞**

> üìå **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è `updatePaymentStatusFromWebhook` –∏–∑ ¬ß4.2 "–°—Ç–∞—Ç—É—Å—ã –ø–ª–∞—Ç–µ–∂–µ–π –∏ state machine"

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏ –¥—É–±–ª—è—Ö:**
```
Webhook #1: payment.succeeded ‚Üí UPDATE status='succeeded' ‚úÖ
Webhook #2: payment.succeeded ‚Üí skip (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å) ‚úÖ
Webhook #3: payment.succeeded ‚Üí skip (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å) ‚úÖ
```

**–†–µ—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü:**
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤ –ª–æ–≥–∏–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ (state machine + –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è)
- ‚úÖ –ó–∞—â–∏—Ç–∞ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ (succeeded/canceled –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è)
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å, —Ñ–æ–∫—É—Å –Ω–∞ –¢–ó

#### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ü–æ–¥–¥–µ–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–°—É—Ç—å:** –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç –ø–æ–¥–¥–µ–ª–∞—Ç—å webhook –∏ —Å–æ–∑–¥–∞—Ç—å —Ñ–µ–π–∫–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –ë–ï–ó –∑–∞—â–∏—Ç—ã:**
- üí∞ –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ (–ø—Ä—è–º—ã–µ —É–±—ã—Ç–∫–∏)
- üö® –ú–∞—Å—Å–æ–≤–∞—è –∞—Ç–∞–∫–∞ (—Ç—ã—Å—è—á–∏ —Ñ–µ–π–∫–æ–≤—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)
- üìâ Data corruption (—Å–≤–µ—Ä–∫–∞ —Å –Æ–ö–∞—Å—Å–æ–π –Ω–µ —Å–æ–π–¥—ë—Ç—Å—è)

**‚úÖ –ù–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ: –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞**

**–£—Ä–æ–≤–Ω–∏ –∑–∞—â–∏—Ç—ã:**
1. **IP Whitelist** (185.71.76.0/27, ...) ‚Üí 403 Forbidden
2. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞** (–µ—Å—Ç—å –ª–∏ paymentId) ‚Üí 400 Bad Request
3. **GET Verification** ‚Üí –∑–∞–ø—Ä–æ—Å –∫ –Æ–ö–∞—Å—Å–µ (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
4. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞** ‚Üí –µ—Å–ª–∏ webhook –ø—Ä–∏—à–µ–ª —Ä–∞–Ω—å—à–µ POST
5. **State machine** ‚Üí –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å—Ç–∞—Ç—É—Å–æ–≤ + –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
6. **–ó–∞—â–∏—Ç–∞ –æ—Ç race conditions** ‚Üí unique constraint (yookassa_payment_id) + –æ–±—Ä–∞–±–æ—Ç–∫–∞ P2002

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ IP Whitelist –±–ª–æ–∫–∏—Ä—É–µ—Ç 99% –∞—Ç–∞–∫
- ‚úÖ GET verification - 100% –≥–∞—Ä–∞–Ω—Ç–∏—è –ª–µ–≥–∏—Ç–∏–º–Ω–æ—Å—Ç–∏ (–¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –∏–∑ –Æ–ö–∞—Å—Å—ã API)
- ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions
- ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ HTTP –∫–æ–¥—ã (403/400/200/500)

**–í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 200 –¥–ª—è —Ñ–µ–π–∫–æ–≤** (—á—Ç–æ–±—ã –Æ–ö–∞—Å—Å–∞ –Ω–µ retry –∏ –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å –∞—Ç–∞–∫—É—é—â–µ–º—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é)

---

üìå **–ü–æ–ª–Ω–∞—è —ç—Ç–∞–ª–æ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å –∫–æ–¥–æ–º:** –°–º. **¬ß7.2 Webhook Security**

### 4.4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

#### 1Ô∏è‚É£ HTTP 500 –æ—Ç –Æ–ö–∞—Å—Å—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** 
```typescript
POST /v3/payments
Idempotence-Key: abc-123

‚Üê 500 Internal Server Error

// ‚ùì –ß—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å:
// ‚úÖ idempotency_key: abc-123
// ‚ùå payment_id: –ù–ï–¢ (–Ω–µ –ø–æ–ª—É—á–∏–ª–∏ –æ—Ç–≤–µ—Ç)
// ‚ùå –í Redis: –ù–ò–ß–ï–ì–û (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –ü–û–°–õ–ï –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞)
// ‚ùå –í –ë–î: –ù–ò–ß–ï–ì–û (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –ü–û–°–õ–ï –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞)
```

**–ß—Ç–æ –º—ã –ù–ï –ú–û–ñ–ï–ú —Å–¥–µ–ª–∞—Ç—å:**
- ‚ùå GET `/payments/{id}` - –Ω–µ—Ç ID
- ‚ùå –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Redis - –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ü–û–°–õ–ï —Å–æ–∑–¥–∞–Ω–∏—è
- ‚ùå –ù–∞–¥—ë–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ –ë–î - –ø–æ–∏—Å–∫ –ø–æ `createdAt`/`amount` –Ω–µ–Ω–∞–¥—ë–∂–µ–Ω (–º–æ–∂–µ—Ç –∑–∞—Ü–µ–ø–∏—Ç—å –¥—Ä—É–≥–æ–π –ø–ª–∞—Ç—ë–∂ —Ç–æ–≥–æ –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

**‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –ü–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –Æ–ö–∞—Å—Å—ã**

```typescript
async function createPayment(data: PaymentData, idempotencyKey: string) {
  try {
    const payment = await yookassaClient.post('/payments', data, {
      headers: { 'Idempotence-Key': idempotencyKey },
      timeout: 35000
    });
    
    // –£—Å–ø–µ—Ö - —Å–æ—Ö—Ä–∞–Ω—è–µ–º
    await savePayment(payment.data);
    await redis.set(
      `idempotency:${idempotencyKey}`, 
      payment.data.id, 
      'EX', 
      86400
    );
    
    return payment.data;
    
  } catch (error) {
    if (error.response?.status === 500) {
      logger.error({ idempotencyKey }, 'YooKassa 500 error');
      
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // –ú—ã –ù–ï –ó–ù–ê–ï–ú —Å–æ–∑–¥–∞–Ω –ø–ª–∞—Ç—ë–∂ –∏–ª–∏ –Ω–µ—Ç
      // –ì–æ–≤–æ—Ä–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Å –¢–ï–ú –ñ–ï –∫–ª—é—á–æ–º
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      throw new YookassaServerError(
        'Payment service temporarily unavailable',
        { 
          retryable: true,
          sameKey: true, // –í–∞–∂–Ω–æ! –¢–æ—Ç –∂–µ –∫–ª—é—á!
        }
      );
    }
    
    throw error;
  }
}

// Frontend –æ–±—Ä–∞–±–æ—Ç–∫–∞:
catch (error) {
  if (error.retryable && error.sameKey) {
    // Retry —Å –¢–ï–ú –ñ–ï idempotency key!
    // –Æ–ö–∞—Å—Å–∞ —Å–∞–º–∞ —Ä–∞–∑–±–µ—Ä—ë—Ç—Å—è:
    // - –ï—Å–ª–∏ –ø–ª–∞—Ç—ë–∂ –±—ã–ª —Å–æ–∑–¥–∞–Ω ‚Üí –≤–µ—Ä–Ω—ë—Ç –µ–≥–æ
    // - –ï—Å–ª–∏ –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω ‚Üí —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–π
  }
}
```

**–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- ‚úÖ –Æ–ö–∞—Å—Å–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (TTL 24 —á–∞—Å–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)
- ‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å —Ç–µ–º –∂–µ –∫–ª—é—á–æ–º –±–µ–∑–æ–ø–∞—Å–µ–Ω
- ‚úÖ –ï—Å–ª–∏ –ø–ª–∞—Ç—ë–∂ –±—ã–ª —Å–æ–∑–¥–∞–Ω ‚Üí –Æ–ö–∞—Å—Å–∞ –≤–µ—Ä–Ω—ë—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
- ‚úÖ –ï—Å–ª–∏ –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω ‚Üí –Æ–ö–∞—Å—Å–∞ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–π

---

#### 2Ô∏è‚É£ –¢–∞–π–º–∞—É—Ç—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –Æ–ö–∞—Å—Å–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º 30 —Å–µ–∫—É–Ω–¥

**–†–µ—à–µ–Ω–∏–µ:**

```typescript
// src/config/yookassa.ts
import axios from 'axios';
import { logger } from '../utils/logger';

const yookassaClient = axios.create({
  baseURL: 'https://api.yookassa.ru/v3',
  timeout: 35000, // ‚Üê 35 —Å–µ–∫—É–Ω–¥ (–±–æ–ª—å—à–µ —á–µ–º —É –Æ–ö–∞—Å—Å—ã)
  auth: {
    username: process.env.YOOKASSA_SHOP_ID!,
    password: process.env.YOOKASSA_SECRET_KEY!
  }
});

// Interceptor –¥–ª—è retry –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ - —Å–º. —Å–µ–∫—Ü–∏—é 3Ô∏è‚É£ –Ω–∏–∂–µ
```

**Note:** –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ –µ–¥–∏–Ω—ã–π interceptor —Å retry –º–µ—Ö–∞–Ω–∏–∑–º–æ–º (—Å–º. —Å–ª–µ–¥—É—é—â—É—é —Å–µ–∫—Ü–∏—é), —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ—è—Ö.

---

#### 3Ô∏è‚É£ Retry –º–µ—Ö–∞–Ω–∏–∑–º –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–ï–¥–∏–Ω—ã–π Interceptor)

**–ü—Ä–æ–±–ª–µ–º—ã –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ—à–∞–µ—Ç Retry:**
1. –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–±–æ–∏ —Å–µ—Ç–∏ (`ETIMEDOUT`, `ECONNRESET`, `ECONNABORTED`, DNS failures)
2. –í—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –Æ–ö–∞—Å—Å—ã (500/502/503)
3. –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –º–æ–±–∏–ª—å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
4. Race conditions –ø—Ä–∏ —Å–ª–∞–±–æ–º —Å–∏–≥–Ω–∞–ª–µ

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:** 90% –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ (500/503) —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ö–æ–¥—è—Ç –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ.

**‚úÖ –†–µ—à–µ–Ω–∏–µ: –ï–¥–∏–Ω—ã–π Interceptor –¥–ª—è retry + –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫**

```typescript
// src/config/yookassa.ts
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ï–î–ò–ù–´–ô interceptor –¥–ª—è retry –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç: —Ç–∞–π–º–∞—É—Ç—ã, 5xx –æ—à–∏–±–∫–∏, —Å–µ—Ç–µ–≤—ã–µ —Å–±–æ–∏
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
yookassaClient.interceptors.response.use(
  response => response,
  async (error) => {
    const config = error.config;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—á—ë—Ç—á–∏–∫ retry
    if (!config._retryCount) {
      config._retryCount = 0;
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –®–ê–ì 1: –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const isNetworkError = error.code === 'ETIMEDOUT' || 
                           error.code === 'ECONNRESET' ||
                           error.code === 'ECONNABORTED' ||
                           error.code === 'ENOTFOUND';
    
    const is5xxError = error.response?.status >= 500;
    
    const shouldRetry = isNetworkError || is5xxError;
    const hasMoreAttempts = config._retryCount < 2; // max 2 retry = 3 –ø–æ–ø—ã—Ç–∫–∏ –≤—Å–µ–≥–æ
    
// Retry —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
const isIdempotent = config.method === 'GET' || 
                     config.headers['Idempotence-Key'];
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –®–ê–ì 2: –ü—ã—Ç–∞–µ–º—Å—è retry (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (shouldRetry && hasMoreAttempts && isIdempotent) {
      config._retryCount += 1;
      
      const delayMs = Math.pow(2, config._retryCount) * 1000; // 2s, 4s
      
      logger.info({ 
        url: config.url, 
        method: config.method,
        attempt: config._retryCount,
        delay: delayMs,
        reason: error.code || error.response?.status
      }, 'Retrying request');
      
      // –ñ–¥—ë–º –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º (exponential backoff)
      await new Promise(resolve => setTimeout(resolve, delayMs));
      
      // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å —Å —Ç–æ–π –∂–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
      return yookassaClient(config);
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –®–ê–ì 3: Retry –∏—Å—á–µ—Ä–ø–∞–Ω—ã –∏–ª–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã ‚Üí —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    // –õ–æ–≥–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –æ—à–∏–±–∫—É
    logger.error({
      url: config.url,
      method: config.method,
      status: error.response?.status,
      code: error.code,
      retryCount: config._retryCount,
      message: error.message
    }, 'Request failed after all retries');
    
    // Timeout –ø–æ—Å–ª–µ –≤—Å–µ—Ö retry ‚Üí —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    if (error.code === 'ETIMEDOUT' || error.code === 'ECONNABORTED') {
      const timeoutError = new Error('Payment request timeout');
      timeoutError.name = 'YookassaTimeoutError';
      timeoutError.retryable = true;  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
      timeoutError.sameKey = true;    // –° —Ç–µ–º –∂–µ idempotency key
      throw timeoutError;
    }
    
    // 500 –æ—à–∏–±–∫–∞ –ø–æ—Å–ª–µ –≤—Å–µ—Ö retry ‚Üí —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    if (error.response?.status === 500) {
      const serverError = new Error('Payment service temporarily unavailable');
      serverError.name = 'YookassaServerError';
      serverError.retryable = true;
      serverError.sameKey = true;
      throw serverError;
    }
    
    // –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ (4xx, network) - –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
    return Promise.reject(error);
  }
);

export default yookassaClient;
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø–æ—à–∞–≥–æ–≤–æ):**

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –£—Å–ø–µ—Ö –Ω–∞ 2-–π –ø–æ–ø—ã—Ç–∫–µ**
```typescript
–ü–æ–ø—ã—Ç–∫–∞ 1: ETIMEDOUT
  ‚Üì
Interceptor: shouldRetry=true, hasMoreAttempts=true, isIdempotent=true
  ‚Üì 
–ñ–¥—ë–º 2 —Å–µ–∫—É–Ω–¥—ã (exponential backoff)
  ‚Üì
–ü–æ–ø—ã—Ç–∫–∞ 2: SUCCESS ‚úÖ
  ‚Üì
–í–æ–∑–≤—Ä–∞—â–∞–µ–º response (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–µ–ª –æ—à–∏–±–∫—É!)
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã**
```typescript
–ü–æ–ø—ã—Ç–∫–∞ 1: ETIMEDOUT
  ‚Üì
Interceptor: retry (–∂–¥—ë–º 2—Å)
  ‚Üì
–ü–æ–ø—ã—Ç–∫–∞ 2: ETIMEDOUT
  ‚Üì
Interceptor: retry (–∂–¥—ë–º 4—Å)
  ‚Üì
–ü–æ–ø—ã—Ç–∫–∞ 3: ETIMEDOUT
  ‚Üì
Interceptor: hasMoreAttempts=false ‚Üí –§–∏–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
  ‚Üì
throw YookassaTimeoutError (retryable=true, sameKey=true)
  ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –æ—à–∏–±–∫—É —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Å —Ç–µ–º –∂–µ –∫–ª—é—á–æ–º
```

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- ‚úÖ Retry —Ç–æ–ª—å–∫–æ –¥–ª—è GET –∏ POST —Å `Idempotence-Key`
- ‚úÖ –ù–ï retry –¥–ª—è 4xx –æ—à–∏–±–æ–∫ (—ç—Ç–æ –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –Ω–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–±–æ–∏)
- ‚úÖ Exponential backoff (2s, 4s) –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫—É API
- ‚úÖ –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏ (1 –∏—Å—Ö–æ–¥–Ω–∞—è + 2 retry)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫

**–ü–æ–ª—å–∑–∞ –¥–ª—è UX:**
```typescript
// –ë–ï–ó retry:
User: –ù–∞–∂–∞–ª "–û–ø–ª–∞—Ç–∏—Ç—å" 
  ‚Üí –û—à–∏–±–∫–∞ "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ" üò°
  ‚Üí –ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–∞–¥–∞–µ—Ç –Ω–∞ 0.5-1%

// –° retry (–µ–¥–∏–Ω—ã–π interceptor):
User: –ù–∞–∂–∞–ª "–û–ø–ª–∞—Ç–∏—Ç—å" 
  ‚Üí –ü–æ–ø—ã—Ç–∫–∞ 1: timeout (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —á–µ—Ä–µ–∑ 2—Å)
  ‚Üí –ü–æ–ø—ã—Ç–∫–∞ 2: 500 error (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —á–µ—Ä–µ–∑ 4—Å)
  ‚Üí –ü–æ–ø—ã—Ç–∫–∞ 3: SUCCESS ‚úÖ
  ‚Üí "–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞!" (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–∂–µ –Ω–µ –∑–∞–º–µ—Ç–∏–ª –ø—Ä–æ–±–ª–µ–º—ã)
```

**–ü–æ—á–µ–º—É –µ–¥–∏–Ω—ã–π interceptor –≤–∞–∂–µ–Ω:**
- ‚ùå **–î–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö interceptor** ‚Üí –∫–æ–Ω—Ñ–ª–∏–∫—Ç (–ø–µ—Ä–≤—ã–π –±–ª–æ–∫–∏—Ä—É–µ—Ç retry –¥–ª—è timeout)
- ‚úÖ **–ï–¥–∏–Ω—ã–π interceptor** ‚Üí retry ‚Üí —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫)

---

#### 4Ô∏è‚É£ –ù–µ—É—Å–ø–µ—à–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (–ü—Ä–∏—á–∏–Ω—ã –æ—Ç–º–µ–Ω—ã)

**–•—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î:**
```sql
-- –í —Ç–∞–±–ª–∏—Ü–µ payments
cancellation_party VARCHAR(50),   -- merchant, yoo_money, payment_network
cancellation_reason VARCHAR(100), -- –∫–æ–¥ –ø—Ä–∏—á–∏–Ω—ã
```

**–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–∏—á–∏–Ω –∏ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**

```typescript
// src/utils/cancellation-messages.ts
export const CANCELLATION_MESSAGES: Record<string, {
  title: string;
  message: string;
  userAction: string;
}> = {
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // User errors (–º–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  '3d_secure_failed': {
    title: '–ù–µ –ø—Ä–æ–π–¥–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ 3D-Secure',
    message: '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –æ–ø–ª–∞—Ç—É –∏ –ø—Ä–æ–π–¥–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.',
    userAction: 'retry'
  },
  
  'insufficient_funds': {
    title: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤',
    message: '–ù–∞ –∫–∞—Ä—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –æ–ø–ª–∞—Ç—ã.',
    userAction: 'add_funds_or_change_card'
  },
  
  'card_expired': {
    title: '–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–∞—Ä—Ç—ã –∏—Å—Ç—ë–∫',
    message: '–ò—Å—Ç—ë–∫ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–∞—Ä—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥—É—é –∫–∞—Ä—Ç—É.',
    userAction: 'change_card'
  },
  
  'invalid_card_number': {
    title: '–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã',
    message: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–µ–¥—ë–Ω–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã.',
    userAction: 'retry'
  },
  
  'invalid_csc': {
    title: '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏',
    message: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–æ–¥–∞ CVV/CVC –Ω–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ –∫–∞—Ä—Ç—ã.',
    userAction: 'retry'
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Bank/issuer errors
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  'call_issuer': {
    title: '–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –±–∞–Ω–∫',
    message: '–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –±–∞–Ω–∫–æ–º. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –±–∞–Ω–∫–æ–º –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã.',
    userAction: 'contact_bank'
  },
  
  'issuer_unavailable': {
    title: '–ë–∞–Ω–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω',
    message: '–ë–∞–Ω–∫-—ç–º–∏—Ç–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ.',
    userAction: 'retry_later'
  },
  
  'payment_method_limit_exceeded': {
    title: '–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç',
    message: '–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –∫–∞—Ä—Ç–µ. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –±–∞–Ω–∫–æ–º.',
    userAction: 'contact_bank_or_change_card'
  },
  
  'payment_method_restricted': {
    title: '–û–ø–µ—Ä–∞—Ü–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞',
    message: '–û–ø–µ—Ä–∞—Ü–∏–∏ —Å —ç—Ç–æ–π –∫–∞—Ä—Ç–æ–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥—É—é –∫–∞—Ä—Ç—É –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –±–∞–Ω–∫–æ–º.',
    userAction: 'change_card_or_contact_bank'
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // System/fraud
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  'fraud_suspected': {
    title: '–ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ –≤ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–µ',
    message: '–û–ø–µ—Ä–∞—Ü–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.',
    userAction: 'contact_support'
  },
  
  'general_decline': {
    title: '–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞',
    message: '–ë–∞–Ω–∫ –æ—Ç–∫–ª–æ–Ω–∏–ª –æ–ø–µ—Ä–∞—Ü–∏—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –∫–∞—Ä—Ç—É –∏–ª–∏ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã.',
    userAction: 'change_payment_method'
  },
  
  'country_forbidden': {
    title: '–°—Ç—Ä–∞–Ω–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è',
    message: '–û–ø–ª–∞—Ç–∞ –∏–∑ –≤–∞—à–µ–π —Å—Ç—Ä–∞–Ω—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã.',
    userAction: 'change_payment_method'
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Technical errors (–Æ–ö–∞—Å—Å–∞)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  'internal_timeout': {
    title: '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–µ–ø–æ–ª–∞–¥–∫–∏',
    message: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å –≤ —Ç–µ—á–µ–Ω–∏–µ 35 —Å–µ–∫—É–Ω–¥. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–ª–∞—Ç—ë–∂ —Å –Ω–æ–≤—ã–º –∫–ª—é—á–æ–º –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏.',
    userAction: 'retry_with_new_key'
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Merchant errors
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  'expired_on_capture': {
    title: '–ò—Å—Ç–µ–∫–ª–æ –≤—Ä–µ–º—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è',
    message: '–í—Ä–µ–º—è –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –∏—Å—Ç–µ–∫–ª–æ. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂.',
    userAction: 'create_new_payment'
  },
  
  'expired_on_confirmation': {
    title: '–ò—Å—Ç–µ–∫–ª–æ –≤—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã',
    message: '–í—Ä–µ–º—è –Ω–∞ –æ–ø–ª–∞—Ç—É –∏—Å—Ç–µ–∫–ª–æ. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂.',
    userAction: 'create_new_payment'
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Special cases
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  'identification_required': {
    title: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è',
    message: '–î–ª—è —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–π—Ç–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –≤ –ÆMoney.',
    userAction: 'complete_identification'
  },
  
  'permission_revoked': {
    title: '–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ—Ç–æ–∑–≤–∞–Ω–æ',
    message: '–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∏ –æ—Ç–æ–∑–≤–∞–Ω–æ. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂.',
    userAction: 'grant_permission_again'
  },
  
  'unsupported_mobile_operator': {
    title: '–û–ø–µ—Ä–∞—Ç–æ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è',
    message: '–í–∞—à –º–æ–±–∏–ª—å–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã.',
    userAction: 'change_payment_method'
  },
};

// Fallback –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω
export const DEFAULT_CANCELLATION_MESSAGE = {
  title: '–ü–ª–∞—Ç—ë–∂ –æ—Ç–º–µ–Ω—ë–Ω',
  message: '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–ª–∞—Ç—ë–∂. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã.',
  userAction: 'retry_or_change_method'
};

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
export function getCancellationMessage(reason: string) {
  return CANCELLATION_MESSAGES[reason] || DEFAULT_CANCELLATION_MESSAGE;
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```typescript
// src/services/payment.service.ts
async function getPaymentDetails(paymentId: string) {
  const payment = await prisma.payments.findUnique({
    where: { id: paymentId }
  });
  
  if (payment.status === 'canceled' && payment.cancellation_reason) {
    const message = getCancellationMessage(payment.cancellation_reason);
    
    return {
      ...payment,
      cancellation_message: message
    };
  }
  
  return payment;
}
```

**API Response Example:**

```json
{
  "id": "pay_123",
  "status": "canceled",
  "cancellation_details": {
    "party": "yoo_money",
    "reason": "insufficient_funds"
  },
  "cancellation_message": {
    "title": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤",
    "message": "–ù–∞ –∫–∞—Ä—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –æ–ø–ª–∞—Ç—ã.",
    "userAction": "add_funds_or_change_card"
  }
}
```

---

**‚úÖ –ò—Ç–æ–≥–æ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—à–∏–±–æ–∫:**

| –¢–∏–ø –æ—à–∏–±–∫–∏ | –ü—Ä–æ–±–ª–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ |
|------------|----------|---------|
| **HTTP 500** | –ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ | –ü–æ–≤—Ç–æ—Ä —Å –¢–ï–ú –ñ–ï –∫–ª—é—á–æ–º (–ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –Æ–ö–∞—Å—Å—ã) |
| **Timeout** | –ó–∞–ø—Ä–æ—Å > 30 —Å–µ–∫ | Timeout 35 —Å–µ–∫, –ø–æ–≤—Ç–æ—Ä —Å —Ç–µ–º –∂–µ –∫–ª—é—á–æ–º |
| **–°–µ—Ç–µ–≤—ã–µ —Å–±–æ–∏** | ETIMEDOUT, ECONNRESET | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry (2-3 –ø–æ–ø—ã—Ç–∫–∏, exponential backoff) |
| **Canceled payment** | 15+ –ø—Ä–∏—á–∏–Ω –æ—Ç–º–µ–Ω—ã | –ü–æ–ª–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |

### 4.5. –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** Webhook —Ç—Ä–µ–±—É–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π HTTPS URL  
**–†–µ—à–µ–Ω–∏–µ:** 
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ngrok –¥–ª—è –ø—Ä–æ–±—Ä–æ—Å–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞
- –£–∫–∞–∑–∞—Ç—å URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –Æ–ö–∞—Å—Å—ã –∏–ª–∏ —á–µ—Ä–µ–∑ API

---

## üóÑÔ∏è 5. –°–¢–†–£–ö–¢–£–†–ê –ë–î

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó**

–°–æ–≥–ª–∞—Å–Ω–æ –¢–ó —Ç—Ä–µ–±—É–µ—Ç—Å—è:
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API –º–µ—Ç–æ–¥—ã –¥–ª—è **–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã**
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å **–æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫**
- ‚úÖ –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å **—Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î**

–ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è:
- ‚ùå –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ (subscriptions)
- ‚ùå –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- ‚ùå –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ SaaS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

**–ü–æ—ç—Ç–æ–º—É –ë–î —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ:**
1. `users` - –¥–ª—è —Å–≤—è–∑–∏ –ø–ª–∞—Ç–µ–∂–µ–π —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
2. `payments` - –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–ª–∞—Ç–µ–∂–∞—Ö

–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–∞—Ö (plan_type, billing_period) —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `payments.metadata` (JSONB).

---

### –¢–∞–±–ª–∏—Ü—ã

#### `users`
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) NOT NULL UNIQUE,
  name VARCHAR(255),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_users_email ON users(email);
```

#### `payments` (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞)
```sql
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- –Æ–ö–∞—Å—Å–∞ –¥–∞–Ω–Ω—ã–µ
  yookassa_payment_id VARCHAR(255) UNIQUE NOT NULL, -- ID –∏–∑ –Æ–ö–∞—Å—Å—ã (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Å–≤—è–∑–∏)
  -- ‚ùå idempotence_key –ù–ï —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î (—Ç–æ–ª—å–∫–æ –≤ Redis —Å TTL 24—á)
  
  -- –°–≤—è–∑—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
  user_id UUID NOT NULL REFERENCES users(id),
  
  -- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
  amount DECIMAL(10,2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'RUB',
  
  -- –°—Ç–∞—Ç—É—Å—ã –∏ –¥–µ—Ç–∞–ª–∏
  status VARCHAR(50) NOT NULL, -- pending, succeeded, canceled (—Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ—Å—Ç–∞–¥–∏–π–Ω–∞—è –æ–ø–ª–∞—Ç–∞)
  paid BOOLEAN DEFAULT FALSE,
  
  -- –î–µ—Ç–∞–ª–∏ –æ–ø–ª–∞—Ç—ã
  payment_method_type VARCHAR(50), -- bank_card, yoo_money, sberbank, etc
  confirmation_type VARCHAR(50), -- redirect, external, qr, etc
  confirmation_url TEXT,
  
  -- –û—Ç–º–µ–Ω–∞ –ø–ª–∞—Ç–µ–∂–∞ (–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫!)
  cancellation_party VARCHAR(50), -- merchant, yoo_money, payment_network
  cancellation_reason VARCHAR(100), -- 3d_secure_failed, insufficient_funds, etc
  
  -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–∑–¥–µ—Å—å –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å plan_type –¥–ª—è SaaS)
  description TEXT,
  metadata JSONB, -- { "plan_type": "premium", "billing_period": "monthly" }
  
  -- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  captured_at TIMESTAMPTZ,
  canceled_at TIMESTAMPTZ
);

CREATE INDEX idx_payments_user_id ON payments(user_id);
CREATE INDEX idx_payments_status ON payments(status);
CREATE INDEX idx_payments_yookassa_id ON payments(yookassa_payment_id);
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:**
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¢–ó (API –º–µ—Ç–æ–¥—ã + –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)
- ‚úÖ `metadata` JSONB –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (plan_type, etc) –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
- ‚úÖ `cancellation_party` –∏ `cancellation_reason` –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- ‚ùå –¢–∞–±–ª–∏—Ü—ã `subscriptions` –∏ `payment_events` –∏—Å–∫–ª—é—á–µ–Ω—ã (–∑–∞ —Ä–∞–º–∫–∞–º–∏ –¢–ó)
- ‚ùå –ü–æ–ª–µ `idempotence_key` –ù–ï —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î:
  - **–ü—Ä–∏—á–∏–Ω–∞:** –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å ‚Äî –≤—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞ (TTL 24 —á–∞—Å–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –Æ–ö–∞—Å—Å—ã)
  - **–†–µ—à–µ–Ω–∏–µ:** Redis —Å TTL 24—á (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ, –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
  - **–°–≤—è–∑—å:** `yookassa_payment_id` –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
  - **Audit:** –ö–ª—é—á–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å `correlationId` –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### –ü—Ä–∏–Ω—Ü–∏–ø Seeds –≤ –ø—Ä–æ–µ–∫—Ç–µ

**Seeds —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–æ–ª—å–∫–æ:**
- ‚úÖ `users` - 2-3 —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API

**Seeds –ù–ï —Å–æ–¥–µ—Ä–∂–∞—Ç:**
- ‚ùå `payments` - —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `POST /api/payments` (–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã API)

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** 
- –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã "—Å –Ω—É–ª—è"
- –§–æ–∫—É—Å –Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ API –º–µ—Ç–æ–¥–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç API —Å–æ–∑–¥–∞–Ω–∏—è –≤ —Ä–∞–º–∫–∞—Ö –¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞

---

## üèóÔ∏è 6. –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø

### 6.1. –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
- **Runtime:** Node.js 20+ (LTS)
- **Framework:** Express.js (–∑—Ä–µ–ª–∞—è —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞, –≥–æ—Ç–æ–≤—ã–µ middleware)
- **Database:** PostgreSQL 15+
- **Cache/Rate Limiting:** Redis 7+
- **ORM:** Prisma (type-safe queries, –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–∏–ø–æ–≤, modern DX)
- **Language:** TypeScript
- **Validation:** Zod (type-safe —Å—Ö–µ–º—ã —Å –∞–≤—Ç–æ–≤—ã–≤–æ–¥–æ–º —Ç–∏–ø–æ–≤, ~10x –ª–µ–≥—á–µ Joi)
- **HTTP Client:** Axios
- **Logging:** Pino (–≤—ã–±—Ä–∞–Ω –∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –ª–µ–≥–∫–æ–≤–µ—Å–Ω–æ—Å—Ç—å)
- **Rate Limiting:** express-rate-limit + rate-limit-redis
- **Environment:** dotenv
- **Testing:** Jest + ts-jest, axios-mock-adapter (HTTP mocks –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Redis:**
- üéØ **Rate Limiting:** –û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ –ø—Ä–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ (multiple instances)
- üîë **Idempotency Keys:** –•—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–µ–π –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º TTL (24—á), –∞—Ç–æ–º–∞—Ä–Ω—ã–π SET NX –¥–ª—è race conditions
- üöÄ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:** –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ (persistence), –≤—ã—Å–æ–∫–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
- ‚ö° **Performance:** Microsecond latency - –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –Ω–∞ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- üîß **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ Docker Compose, –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### 6.2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
src/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ database.ts
‚îÇ   ‚îî‚îÄ‚îÄ redis.ts           # Redis –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ yookassa.ts
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ payments.controller.ts
‚îÇ   ‚îî‚îÄ‚îÄ webhooks.controller.ts
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ yookassa.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ payment.service.ts
‚îú‚îÄ‚îÄ repositories/
‚îÇ   ‚îî‚îÄ‚îÄ payment.repository.ts
‚îÇ   ‚îî‚îÄ‚îÄ user.repository.ts
‚îú‚îÄ‚îÄ middlewares/
‚îÇ   ‚îî‚îÄ‚îÄ error-handler.ts
‚îÇ   ‚îî‚îÄ‚îÄ validation.ts
‚îÇ   ‚îî‚îÄ‚îÄ webhook-validator.ts
‚îÇ   ‚îî‚îÄ‚îÄ rate-limiter.ts       # Rate limiting —Å Redis
‚îÇ   ‚îî‚îÄ‚îÄ idempotency.middleware.ts  # Idempotency validation
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ payment.model.ts
‚îÇ   ‚îî‚îÄ‚îÄ user.model.ts
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ idempotence.ts
‚îÇ   ‚îî‚îÄ‚îÄ logger.ts
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ yookassa.types.ts
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îî‚îÄ‚îÄ app.ts
```

### 6.3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Redis –∏ Docker

#### Redis –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```typescript
// src/config/redis.ts
import { createClient } from 'redis';
import { logger } from '../utils/logger';

export const redisClient = createClient({
  url: process.env.REDIS_URL || 'redis://redis:6379',
  socket: {
    reconnectStrategy: (retries) => {
      if (retries > 10) {
        logger.error('Redis: Max reconnection attempts reached');
        return new Error('Max reconnection attempts reached');
      }
      const delay = Math.min(retries * 50, 500);
      logger.warn(`Redis: Reconnecting in ${delay}ms (attempt ${retries})`);
      return delay;
    },
  },
});

// –°–æ–±—ã—Ç–∏—è Redis
redisClient.on('connect', () => {
  logger.info('Redis: Connected successfully');
});

redisClient.on('error', (err) => {
  logger.error({ error: err }, 'Redis: Connection error');
});

redisClient.on('ready', () => {
  logger.info('Redis: Ready to accept commands');
});

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
export async function connectRedis() {
  try {
    await redisClient.connect();
    logger.info('Redis: Client connected and ready');
  } catch (error) {
    logger.error({ error }, 'Redis: Failed to connect');
    throw error;
  }
}

// Graceful disconnect
export async function disconnectRedis() {
  try {
    await redisClient.quit();
    logger.info('Redis: Disconnected gracefully');
  } catch (error) {
    logger.error({ error }, 'Redis: Error during disconnect');
  }
}
```

#### Docker Compose
```yaml
# docker-compose.yml
version: '3.8'

services:
  # PostgreSQL
  postgres:
    image: postgres:15-alpine
    container_name: payment-service-db
    environment:
      POSTGRES_DB: payment_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"  # –î–æ—Å—Ç—É–ø–µ–Ω —Å —Ö–æ—Å—Ç–∞ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - payment-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis
  redis:
    image: redis:7-alpine
    container_name: payment-service-redis
    ports:
      - "6379:6379"  # –î–æ—Å—Ç—É–ø–µ–Ω —Å —Ö–æ—Å—Ç–∞ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - payment-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Application (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Docker)
  app:
    build: .
    container_name: payment-service-app
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
      # –í–Ω—É—Ç—Ä–∏ Docker –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–µ–Ω–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/payment_service
      REDIS_URL: redis://redis:6379
      YOOKASSA_SHOP_ID: ${YOOKASSA_SHOP_ID}
      YOOKASSA_SECRET_KEY: ${YOOKASSA_SECRET_KEY}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - payment-network
    volumes:
      - .:/app
      - /app/node_modules
    profiles:
      - full

networks:
  payment-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
```

**–ö–æ–º–∞–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞:**

```bash
# –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (—Ç–æ–ª—å–∫–æ PostgreSQL + Redis)
docker-compose up -d

# App –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ
npm run dev

# –ü–æ–ª–Ω—ã–π —Å—Ç–µ–∫ (PostgreSQL + Redis + App –≤ Docker)
docker-compose --profile full up -d
```

#### Environment –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
```bash
# .env (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ - app –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤–Ω–µ Docker)
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/payment_service
REDIS_URL=redis://localhost:6379

YOOKASSA_SHOP_ID=513230
YOOKASSA_SECRET_KEY=test_*gN9zkh76GRw4DpuA8z9lWxMXvcJYb78bd_UaqAbw9l2Y

PORT=3000
NODE_ENV=development
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ app –≤ Docker (`--profile full`), DATABASE_URL –∏ REDIS_URL –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∏–º–µ–Ω–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (postgres, redis) –≤–º–µ—Å—Ç–æ localhost.

### 6.4. API Endpoints –Ω–∞—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞

#### `POST /api/payments`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞  
**Request:**
```json
{
  "userId": "uuid",
  "amount": "100.00",
  "currency": "RUB",
  "description": "–ü–æ–¥–ø–∏—Å–∫–∞ Premium –Ω–∞ 1 –º–µ—Å—è—Ü",
  "metadata": {
    "plan_type": "premium",
    "billing_period": "monthly"
  },
  "returnUrl": "https://myapp.com/payment/result"
}
```
**Response:**
```json
{
  "id": "uuid",
  "status": "pending",
  "confirmationUrl": "https://yookassa.ru/...",
  "expiresAt": "2024-01-20T12:00:00Z"
}
```

#### `GET /api/payments/:id`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞  
**Response:**
```json
{
  "id": "uuid",
  "status": "succeeded",
  "amount": "100.00",
  "currency": "RUB",
  "paid": true,
  "createdAt": "2024-01-20T10:00:00Z",
  "capturedAt": "2024-01-20T10:05:00Z"
}
```

#### `POST /api/webhooks/yookassa`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–∏–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç –Æ–ö–∞—Å—Å—ã  
**Security:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ IP –∞–¥—Ä–µ—Å–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ GET /payments/:id

---

## üîê 7. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### 7.1. –ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ `SECRET_KEY` –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (–Ω–µ –≤ –∫–æ–¥–µ!)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ SQL injection –∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ ORM/prepared statements
- ‚úÖ Rate limiting —Å Redis –¥–ª—è API endpoints (–∑–∞—â–∏—Ç–∞ –æ—Ç DDoS –∏ brute-force)

### 7.2. Webhook Security

> üìå **–≠–¢–ê–õ–û–ù–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø** ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è webhook –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ.  
> –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è webhook –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª.

---

**‚ö†Ô∏è Rate Limiter –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è webhooks!**

**–ü–æ—á–µ–º—É:**
- –Æ–ö–∞—Å—Å–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç webhook –¥–æ 24 —á–∞—Å–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ (429 —Ç–æ–∂–µ –æ—à–∏–±–∫–∞)
- Rate limiter –º–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ª–µ–≥–∏—Ç–∏–º–Ω—ã–π webhook
- –†–∏—Å–∫ "–∑–∞—Å—Ç—Ä–µ–≤–∞–Ω–∏—è" –ø–ª–∞—Ç–µ–∂–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ

---

**–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞ webhook:**

```typescript
// 1. IP Whitelist - –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö IP –Æ–ö–∞—Å—Å—ã (–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)
const YOOKASSA_IPS = [
  '185.71.76.0/27',
  '185.71.77.0/27',
  '77.75.153.0/25',
  '77.75.156.11',      // –û–¥–∏–Ω–æ—á–Ω—ã–π IP
  '77.75.156.35',      // –û–¥–∏–Ω–æ—á–Ω—ã–π IP  
  '77.75.154.128/25',
  '2a02:5180::/32'     // IPv6
];

function isYookassaIP(ip: string): boolean {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ CIDR ranges –∏ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö IP
  return YOOKASSA_IPS.some(range => isIPInRange(ip, range));
}

// 2. Webhook handler: IP validation + GET verification + –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
async function handleWebhook(req: Request, res: Response) {
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –£—Ä–æ–≤–µ–Ω—å 1: IP Whitelist (–∂—ë—Å—Ç–∫–∏–π –æ—Ç–∫–∞–∑)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  if (!isYookassaIP(req.ip)) {
    logger.warn({ ip: req.ip }, 'Webhook from non-YooKassa IP blocked');
    return res.status(403).json({ error: 'Forbidden' });
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –£—Ä–æ–≤–µ–Ω—å 2: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const paymentId = req.body?.object?.id;
  if (!paymentId) {
    logger.error('Invalid webhook format - missing payment ID');
    return res.status(400).json({ error: 'Invalid webhook data' });
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –£—Ä–æ–≤–µ–Ω—å 3: GET Verification (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  try {
    const actualPayment = await yookassaService.getPayment(paymentId);
    
    // –§–µ–π–∫–æ–≤—ã–π webhook: –ø–ª–∞—Ç—ë–∂ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –Æ–ö–∞—Å—Å–µ
    if (!actualPayment) {
      logger.error({ paymentId }, 'Fake webhook - payment not found in YooKassa');
      return res.status(200).json({ message: 'Ignored' });
    }
    
    // –§–µ–π–∫–æ–≤—ã–π webhook: —Å—Ç–∞—Ç—É—Å –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
    if (actualPayment.status !== req.body.object.status) {
      logger.error({ 
        paymentId, 
        webhookStatus: req.body.object.status, 
        actualStatus: actualPayment.status 
      }, 'Fake webhook - status mismatch');
      return res.status(200).json({ message: 'Ignored' });
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // –£—Ä–æ–≤–µ–Ω—å 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–ª–∞—Ç–µ–∂–∞ –≤ –ë–î
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let payment = await prisma.payments.findUnique({
      where: { yookassaPaymentId: paymentId }
    });
    
    // Webhook –ø—Ä–∏—à–µ–ª —Ä–∞–Ω—å—à–µ POST ‚Üí –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
    if (!payment) {
      logger.info({ paymentId, event: req.body.event }, 
        'Payment not found in DB - webhook arrived before POST, restoring from YooKassa');
      
      payment = await prisma.payments.create({
        data: {
          yookassaPaymentId: actualPayment.id,
          userId: actualPayment.metadata?.userId,
          amount: parseFloat(actualPayment.amount.value),
          currency: actualPayment.amount.currency,
          status: mapYookassaStatus(actualPayment.status),
          paid: actualPayment.paid,
          paymentMethodType: actualPayment.payment_method?.type,
          confirmationType: actualPayment.confirmation?.type,
          confirmationUrl: actualPayment.confirmation?.confirmation_url,
          description: actualPayment.description,
          metadata: actualPayment.metadata,
        }
      });
      
      logger.info({ paymentId, dbPaymentId: payment.id }, 'Payment restored');
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚úÖ Webhook –ª–µ–≥–∏—Ç–∏–º–Ω—ã–π - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    await updatePaymentStatus(payment.id, actualPayment.status);
    return res.status(200).json({ success: true });
    
  } catch (error) {
    // GET –∑–∞–ø—Ä–æ—Å –≤–µ—Ä–Ω—É–ª 404 ‚Üí –ø–ª–∞—Ç—ë–∂ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (error.response?.status === 404) {
      logger.error({ paymentId }, 'Fake webhook - 404 from YooKassa');
      return res.status(200).json({ message: 'Ignored' });
    }
    
    // Race condition –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
    if (error.code === 'P2002') {
      logger.warn({ paymentId }, 'Payment already restored (race condition)');
      const existing = await prisma.payments.findUnique({
        where: { yookassaPaymentId: paymentId }
      });
      if (existing) {
        await updatePaymentStatus(existing.id, req.body.object.status);
      }
      return res.status(200).json({ success: true });
    }
    
    // –†–µ–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
    logger.error({ error }, 'Webhook processing error');
    return res.status(500).json({ error: 'Internal error' });
  }
}

// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ routes
app.post('/api/webhooks/yookassa', handleWebhook);
```

---

#### –°—Ç—Ä–∞—Ç–µ–≥–∏—è HTTP –∫–æ–¥–æ–≤ –æ—Ç–≤–µ—Ç–∞

| –°–∏—Ç—É–∞—Ü–∏—è | HTTP Code | –Æ–ö–∞—Å—Å–∞ retry? | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|----------|-----------|---------------|-------------|
| **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π IP** | 403 | –ù–µ—Ç | –ñ—ë—Å—Ç–∫–∏–π –æ—Ç–∫–∞–∑, –Ω–µ –Æ–ö–∞—Å—Å–∞ |
| **–ù–µ—Ç paymentId –≤ —Ç–µ–ª–µ** | 400 | –î–∞ | –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç webhook |
| **–ü–ª–∞—Ç—ë–∂ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –Æ–ö–∞—Å—Å–µ** | 200 | –ù–µ—Ç | –§–µ–π–∫ ‚Üí —Å–∫—Ä—ã–≤–∞–µ–º –æ—Ç –∞—Ç–∞–∫—É—é—â–µ–≥–æ |
| **–°—Ç–∞—Ç—É—Å –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç** | 200 | –ù–µ—Ç | –§–µ–π–∫ ‚Üí —Å–∫—Ä—ã–≤–∞–µ–º –æ—Ç –∞—Ç–∞–∫—É—é—â–µ–≥–æ |
| **404 –æ—Ç –Æ–ö–∞—Å—Å—ã** | 200 | –ù–µ—Ç | –§–µ–π–∫ ‚Üí —Å–∫—Ä—ã–≤–∞–µ–º |
| **Webhook —Ä–∞–Ω—å—à–µ POST** | 200 | –ù–µ—Ç | –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –ø–ª–∞—Ç—ë–∂ ‚Üí OK |
| **Race condition (P2002)** | 200 | –ù–µ—Ç | –£–∂–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥—Ä—É–≥–∏–º –ø–æ—Ç–æ–∫–æ–º |
| **–î—É–±–ª–∏–∫–∞—Ç webhook** | 200 | –ù–µ—Ç | –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å ‚Üí OK |
| **–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (–ë–î, —Å–µ—Ç—å)** | 500 | –î–∞ | –í—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ ‚Üí –Æ–ö–∞—Å—Å–∞ retry |
| **–£—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** | 200 | –ù–µ—Ç | OK |

**–ö–ª—é—á–µ–≤–æ–π –ø—Ä–∏–Ω—Ü–∏–ø:** –í–æ–∑–≤—Ä–∞—â–∞–µ–º 200 –¥–ª—è –≤—Å–µ—Ö —Ñ–µ–π–∫–æ–≤—ã—Ö webhook (–ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ IP), —á—Ç–æ–±—ã:
- –ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å –∞—Ç–∞–∫—É—é—â–µ–º—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –ù–µ –∑–∞—Å—Ç–∞–≤–ª—è—Ç—å –Æ–ö–∞—Å—Å—É –¥–µ–ª–∞—Ç—å –±–µ—Å–ø–æ–ª–µ–∑–Ω—ã–µ retry

---

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ POST /api/webhooks/yookassa                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ –£—Ä–æ–≤–µ–Ω—å 1: IP Check    ‚îÇ
        ‚îÇ ‚ùå ‚Üí 403 Forbidden     ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ –£—Ä–æ–≤–µ–Ω—å 2: –§–æ—Ä–º–∞—Ç      ‚îÇ
        ‚îÇ ‚ùå ‚Üí 400 Bad Request   ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ –£—Ä–æ–≤–µ–Ω—å 3: GET Verification    ‚îÇ
        ‚îÇ (–Æ–ö–∞—Å—Å–∞ = –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)     ‚îÇ
        ‚îÇ ‚îú‚îÄ –ù–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí 200 'Fake'  ‚îÇ
        ‚îÇ ‚îî‚îÄ –°—Ç–∞—Ç—É—Å ‚â† ‚Üí 200 'Fake'       ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ –£—Ä–æ–≤–µ–Ω—å 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î         ‚îÇ
        ‚îÇ ‚îú‚îÄ –ï—Å—Ç—å ‚Üí Update status        ‚îÇ
        ‚îÇ ‚îî‚îÄ –ù–µ—Ç ‚Üí ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å        ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ ‚úÖ return 200 { success: true }‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìù 8. –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò (–ü–æ—ç—Ç–∞–ø–Ω—ã–π)

### Phase 1: Setup & Infrastructure
- [ ] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ (Node.js + TypeScript)
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Prisma (ORM + –º–∏–≥—Ä–∞—Ü–∏–∏)
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î
- [ ] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

### Phase 2: Core Domain Logic
- [ ] –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (User, Payment)
- [ ] Repository layer
- [ ] Service layer (business logic)
- [ ] State machine –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π

### Phase 3: –Æ–ö–∞—Å—Å–∞ Integration
- [ ] YookassaService (HTTP client)
- [ ] –ú–µ—Ç–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
- [ ] –ú–µ—Ç–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤
- [ ] –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

### Phase 4: API Endpoints
- [ ] POST /api/payments (—Å–æ–∑–¥–∞–Ω–∏–µ)
- [ ] GET /api/payments/:id (—Å—Ç–∞—Ç—É—Å)
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] Error handling middleware

### Phase 5: Webhooks
- [ ] POST /api/webhooks/yookassa endpoint
- [ ] IP validation middleware
- [ ] Status verification
- [ ] –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

### Phase 6: Testing & Documentation
- [ ] Unit tests (services, controllers, middlewares)
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å ngrok (—Ä—É—á–Ω–æ–µ)
- [ ] README.md —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π –∏ –ø—Ä–æ–±–ª–µ–º

---

## üß™ 9. –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### 9.1. –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ngrok:**
```bash
# –ó–∞–ø—É—Å–∫ ngrok
ngrok http 3000

# –ü–æ–ª—É—á–∞–µ–º URL: https://abc123.ngrok.io
# –£–∫–∞–∑—ã–≤–∞–µ–º –≤ –Æ–ö–∞—Å—Å–µ: https://abc123.ngrok.io/api/webhooks/yookassa
```

### 9.2. –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –Æ–ö–∞—Å—Å—ã
```
shop_id: 513230
secret_key: test_*gN9zkh76GRw4DpuA8z9lWxMXvcJYb78bd_UaqAbw9l2Y
```

### 9.3. –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
- ‚úÖ –£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂ (–±–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞)
- ‚úÖ –û—Ç–º–µ–Ω–∞ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- ‚úÖ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤
- ‚úÖ –ò—Å—Ç–µ—á–µ–Ω–∏–µ —Å—Ä–æ–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- ‚úÖ –î—É–±–ª–∏–∫–∞—Ç webhook
- ‚úÖ –ù–µ–≤–µ—Ä–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ webhook
- ‚úÖ HTTP 500 –æ—Ç –Æ–ö–∞—Å—Å—ã

---

## ‚úÖ 10. –ö–†–ò–¢–ï–†–ò–ò –ì–û–¢–û–í–ù–û–°–¢–ò

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π MVP –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å:
- ‚úÖ –†–∞–±–æ—Ç–∞—é—â–∞—è –ë–î —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
- ‚úÖ Redis –¥–ª—è rate limiting + idempotency keys
- ‚úÖ API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
- ‚úÖ API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
- ‚úÖ Webhook handler
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (Redis-based, –∫–ª—é—á –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è API-–∫–ª–∏–µ–Ω—Ç–æ–º)
- ‚úÖ Rate limiting –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç DDoS
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ Docker Compose (PostgreSQL + Redis + App)
- ‚úÖ README —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π –∏ –ø—Ä–æ–±–ª–µ–º

